<!DOCTYPE HTML>
<html class="no-js" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--[if lte IE 9]>
<meta http-equiv="refresh" content="0;url=http://southrivers.github.io/warn.html">
<![endif]-->
<meta charset="utf-8">
<meta http-equiv="X-DNS-Prefetch-Control" content="on">
<link rel="dns-prefetch" href="http://southrivers.github.io">
<link rel="dns-prefetch" href="//www.google-analytics.com">
<link rel="prefetch" href="http://southrivers.github.io">
<link rel="prefetch" href="//www.google-analytics.com">


<link rel="prerender" href="http://southrivers.github.io">

<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
<meta http-equiv="mobile-agent" content="format=html5; url=http://southrivers.github.io">
<meta name="author" content="John Doe">
<link rel="stylesheet" href="/css/JSimple.css">

<link rel="shortcut icon" href="/images/favicon.png">


<title>sentry学习总结 - 离亭燕</title>

<meta name="keywords" content>

<meta name="description " content>

    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                processEscapes: true
            }
        });
    </script>


    

    

</head>
<body>
<div id="nav">
    <nav class="nav-menu">
        <a class="site-name current" href="/" title="夏">夏</a>
        <a class="site-index current" href="/"><i class="fa fa-home"></i><span>首页</span></a>
        <a href="/archives" title="归档"><i class="fa fa-archives"></i><span>归档</span></a>

        <!-- custom single page of menus -->
        
    </nav>
</div>

<div class="nav-user">
    <a class="btn-search" href="#"><i class="fa fa-search"></i></a>
    <a class="btn-read-mode" href="#"><i class="fa fa-sun-o"></i></a>
    <a class="btn-sns-qr" href="javascript:"><i class="fa fa-telegram"></i></a>
</div>

<div id="wrapper" class="clearfix">
    <div id="body">
        <div class="main" id="main">
            <div id="cover">
    <div class="cover-img"></div>
    <div class="cover-info">
        
        <h1 class="cover-siteName">血刀老祖</h1>
        <h3 class="cover-siteTitle">码个蛋</h3>
        <p class="cover-siteDesc">东门黄犬</p>
        <div class="cover-sns">
            

        </div>
    </div>
</div>

            <div class="page-title">
    <ul>
        <li><a href="/">最近</a></li>
        

        
        <li class="page-search">
    <form id="search" class="search-form">
        <input type="text" readonly="readonly" id="local-search-input-tip" placeholder="读物检索~">
        <button type="button" disabled="disabled" class="search-form-submit"><i class="fa fa-search"></i></button>
    </form>
</li>

    </ul>
</div>
<div class="main-inner">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
        <div class="post-header">
            <div class="post-author clearfix">
                <a class="avatar fleft" href="http://southrivers.github.io" target="_blank">
                    <img width="48" src="/images/favicon.png" alt="avatar">
                </a>
                <p><span class="label">author</span>
                    <a href="http://southrivers.github.io" target="_blank">原站</a>
                    <span title="last_edited&nbsp;2019-11-23">2019-11-23</span>
                </p>
                <p>码个蛋️️</p>
            </div>
            <h2 class="post-title">sentry学习总结</h2>

        </div>
        <div class="post-content markdown-body">
            <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>sentry是大数据安全组件，用于管控hive、hbase等组件权限的控制，在hadoop3.0之后使用到的安全组件是ranger，sentry已经废弃，不过很多大数据平台
版本依然是2.x，而且这种安全组件原理也是相通的，因此有必要研究一下（主要是最近被分到了这个组件，😄），由于在工程实践中我们这里更多的是使用sentry
管控hive的权限，因此有必要在介绍sentry之前对hive的体系结构进行说明。</p>
<h1 id="HIVE概述"><a href="#HIVE概述" class="headerlink" title="HIVE概述"></a>HIVE概述</h1><h2 id="HIVE架构"><a href="#HIVE架构" class="headerlink" title="HIVE架构"></a>HIVE架构</h2><p>如下图所示为hive的架构：
<img src="//southrivers.github.io/2019/11/23/sentry学习总结/hive%E6%9E%B6%E6%9E%84.png" alt></p>
<ul>
<li>UI：hive的客户端，包含了hiveCli、beeLine，用户通过UI来实现自己的操作，CliDriver是SQL本地直接编译，然后访问metastore，并提交作业，是重客户端，BeeLine会将SQL提交给Hive Server2，由Hive server2编译，然后访问metastore，并提交作业，是轻客户端。（因此在使用sentry来管控权限的时候，通过hiveCli是无法完美的做到权限管控的，通过beeLine来进行操作才是可以，原因见下面hive的扩展机制）</li>
<li>Driver：接收查询请求，并处理会话</li>
<li>Complier：解析查询语句，做语义分析，借助于metastore来生成执行计划</li>
<li>Execution Engine：用来执行生成的执行计划，是Hive和Hadoop的桥梁</li>
<li>metastore：提供hive元数据相关的服务</li>
</ul>
<h2 id="HIVE扩展机制"><a href="#HIVE扩展机制" class="headerlink" title="HIVE扩展机制"></a>HIVE扩展机制</h2><p>下面来看一下HIVE中存在的扩展机制，sentry的权限的控制就是基于这种扩展机制完成的：
<img src="//southrivers.github.io/2019/11/23/sentry学习总结/hive%E6%89%A9%E5%B1%95%E6%9C%BA%E5%88%B6.png" alt>
在生产环境中，hive通常会对应3个不同的进程，这些进程分别是Hive server、Metastore、RDBMS，其中提供扩展机制的是：</p>
<ul>
<li>Metastore的Listener</li>
<li>hive server的Hook</li>
</ul>
<p>测试需要，我本地搭建了一个hive的环境，下面是针对Listener和Hook的测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.metastore.MetaStorePreEventListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.metastore.api.InvalidOperationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.metastore.api.MetaException;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.metastore.api.NoSuchObjectException;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.metastore.events.PreEventContext;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomListener1</span> <span class="keyword">extends</span> <span class="title">MetaStorePreEventListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomListener1</span><span class="params">(Configuration config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(config);</span><br><span class="line">        System.out.println(<span class="string">"初始化 CustomListener1"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(PreEventContext preEventContext)</span> <span class="keyword">throws</span> MetaException, NoSuchObjectException, InvalidOperationException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"MetaStorePreEventListener"</span> + preEventContext + preEventContext.getEventType());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.metastore.MetaStoreEventListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.metastore.api.MetaException;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.metastore.events.CreateTableEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.metastore.events.DropTableEvent;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomListener</span> <span class="keyword">extends</span> <span class="title">MetaStoreEventListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomListener</span><span class="params">(Configuration config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(config);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreateTable</span><span class="params">(CreateTableEvent tableEvent)</span> <span class="keyword">throws</span> MetaException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"wes create table : "</span> + tableEvent.getTable());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDropTable</span><span class="params">(DropTableEvent tableEvent)</span> <span class="keyword">throws</span> MetaException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"wes drop table : "</span> + tableEvent.getTable());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.hooks.ExecuteWithHookContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.hooks.HookContext;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HiveExampleHook</span> <span class="keyword">implements</span> <span class="title">ExecuteWithHookContext</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(HookContext hookContext)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"hello wes, this is hive hook !"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是将这些listener、hook注册到hive之后运行相关的DDL、DML操作的时候触发的事件，如下：
<img src="//southrivers.github.io/2019/11/23/sentry学习总结/hive%E6%89%A9%E5%B1%95%E4%BB%A3%E7%A0%81%E6%BC%94%E7%A4%BA.png" alt>
上面测试的Listener和Hook也是sentry使用到的Listener和Hook，sentry中使用Hook鉴权，
使用Listener监听权限及相关的元数据的变更， 并通知到服务端，在sentry的listener中会
从生成的事件中获取事件的id，并将事件的id记录到hive的metastore中， 之后hive的hivemetastoreclient
定时拉取相关的事件并更新到sentry server端的数据库中， 但是在实际测试的过程中却发现应
该存在的事件id真实情况却是null， 线上测试环境中有相关的指标，怀疑和使用的hive版本有关
系或并非所有的event都有eventid。 查看hive的metastore所使用到的数据库发现有表专门对
notification进行了记录，下面展示了eventid为空的情况：
<img src="//southrivers.github.io/2019/11/23/sentry学习总结/id%E4%B8%BA%E7%A9%BA.png" alt>
关于hive的相关的知识就到这里，下面我们来看一下sentry的整体架构。</p>
<h1 id="sentry"><a href="#sentry" class="headerlink" title="sentry"></a>sentry</h1><h2 id="ER关系图"><a href="#ER关系图" class="headerlink" title="ER关系图"></a>ER关系图</h2><p>下图展示了sentry的实体关系图（有些表的作用尚不清楚）
<img src="//southrivers.github.io/2019/11/23/sentry学习总结/sentryER%E5%85%B3%E7%B3%BB%E5%9B%BE.png" alt>
上面的关系表可以看到的是权限的控制是通过RBAC的方式，不过这里的角色是和group绑定的，并不是user，可以让用户加入不同的组来完成权限的控制，
不过用户和组的绑定关系并没有对应的表，而是复用了hadoop中user和group的关系，这一点不论从当前的表中还是代码中都可以得到印证。</p>
<h2 id="sentry整体架构"><a href="#sentry整体架构" class="headerlink" title="sentry整体架构"></a>sentry整体架构</h2><p><img src="//southrivers.github.io/2019/11/23/sentry学习总结/sentry%E6%9E%B6%E6%9E%84.png" alt>
如上图所示为sentry整体架构图，其中sentry-binding就是利用了Hive上面的扩展机制，
分别使用Listener和Hook对数据的DDL、DML操作进行权限的控制，sentry实现的Listener和Hook的主要的作用：</p>
<ul>
<li>Listener主要是针对DDL操作发布对应的事件的id，这样sentryServer端会使用HMSFollower从hive的metastore处进行同步相关的数据。</li>
<li>Hook的话，会截取DML中的信息，并进行鉴权操作，也会截取DDL中的信息进行授权操作，这个具体可以看下面的代码</li>
</ul>
<h2 id="权限的grant、revoke以及权限的校验"><a href="#权限的grant、revoke以及权限的校验" class="headerlink" title="权限的grant、revoke以及权限的校验"></a>权限的grant、revoke以及权限的校验</h2><p>在hive-binding模块的HiveAuthzBindingHook的postAnalyze中会将task转换成SentryGrantRevokeTask，SentryGrantRevokeTask中重
写的execute方法中通过RPC请求执行了权限的grant、revoke操作。
HiveAuthzBindingHook 继承了AbstractSemanticAnalyzerHook，重写的两个重要的方法分别是preAnalyze、postAnalyze两个方法，
我们来看一下这两个方法所做的操作：</p>
<h3 id="client端鉴权操作（sentry-binding模块）"><a href="#client端鉴权操作（sentry-binding模块）" class="headerlink" title="client端鉴权操作（sentry-binding模块）"></a>client端鉴权操作（sentry-binding模块）</h3><h4 id="preAnalyze"><a href="#preAnalyze" class="headerlink" title="preAnalyze"></a>preAnalyze</h4><p>下面是preAnalyze方法，我们可以看到preAnalyze所做的操作仅仅是提取hiveSQL语句中的分区、库、表等信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ASTNode <span class="title">preAnalyze</span><span class="params">(HiveSemanticAnalyzerHookContext context, ASTNode ast)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> SemanticException </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (ast.getToken().getType()) &#123;</span><br><span class="line">  <span class="comment">// Hive parser doesn't capture the database name in output entity, so we store it here for now</span></span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_CREATEDATABASE:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERDATABASE_PROPERTIES:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_DROPDATABASE:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_SWITCHDATABASE:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_DESCDATABASE:</span><br><span class="line">      <span class="comment">// 针对库的操作，只需要提取对应的数据库即可</span></span><br><span class="line">      currDB = <span class="keyword">new</span> Database(BaseSemanticAnalyzer.unescapeIdentifier(ast.getChild(<span class="number">0</span>).getText()));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_CREATETABLE:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_CREATEVIEW:</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">       * Compiler doesn't create read/write entities for create table.</span></span><br><span class="line"><span class="comment">       * Hence we need extract dbname from db.tab format, if applicable</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      currDB = extractDatabase((ASTNode)ast.getChild(<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_DROPTABLE:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_DROPVIEW:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_SHOW_CREATETABLE:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERTABLE_SERIALIZER:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERVIEW_ADDPARTS:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERVIEW_DROPPARTS:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERVIEW_PROPERTIES:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERVIEW_RENAME:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERVIEW:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_DROPINDEX:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_LOCKTABLE:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_UNLOCKTABLE:</span><br><span class="line">      currTab = extractTable((ASTNode)ast.getFirstChildWithType(HiveParser.TOK_TABNAME));</span><br><span class="line">      currDB = extractDatabase((ASTNode) ast.getChild(<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_CREATEINDEX:</span><br><span class="line">      currTab = extractTable((ASTNode)ast.getFirstChildWithType(HiveParser.TOK_TABNAME));</span><br><span class="line">      currDB = extractDatabase((ASTNode) ast.getChild(<span class="number">0</span>));</span><br><span class="line">      indexURI = extractTableLocation(ast);<span class="comment">//As index location is captured using token HiveParser.TOK_TABLELOCATION</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERINDEX_REBUILD:</span><br><span class="line">      currTab = extractTable((ASTNode)ast.getChild(<span class="number">0</span>)); <span class="comment">//type is not TOK_TABNAME</span></span><br><span class="line">      currDB = extractDatabase((ASTNode) ast.getChild(<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_SHOW_TABLESTATUS:</span><br><span class="line">      currDB = extractDatabase((ASTNode)ast.getChild(<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">int</span> children = ast.getChildCount();</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; children; i++) &#123;</span><br><span class="line">        ASTNode child = (ASTNode) ast.getChild(i);</span><br><span class="line">        <span class="keyword">if</span> (child.getToken().getType() == HiveParser.Identifier) &#123;</span><br><span class="line">          currDB = <span class="keyword">new</span> Database(child.getText());</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//loosing the requested privileges for possible wildcard tables, since</span></span><br><span class="line">      <span class="comment">//further authorization will be done at the filter step and those unwanted will</span></span><br><span class="line">      <span class="comment">//eventually be filtered out from the output</span></span><br><span class="line">      currTab = Table.ALL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERTABLE_RENAME:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERTABLE_PROPERTIES:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERTABLE_DROPPARTS:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERTABLE_RENAMECOL:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERTABLE_ADDCOLS:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERTABLE_REPLACECOLS:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_SHOW_TBLPROPERTIES:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_SHOWINDEXES:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_SHOWPARTITIONS:</span><br><span class="line">      <span class="comment">//token name TOK_TABNAME is not properly set in this case</span></span><br><span class="line">      currTab = extractTable((ASTNode)ast.getChild(<span class="number">0</span>));</span><br><span class="line">      currDB = extractDatabase((ASTNode)ast.getChild(<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_MSCK:</span><br><span class="line">      extractDbTableNameFromTOKTABLE((ASTNode) ast.getChild(<span class="number">1</span>));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERTABLE_ADDPARTS:</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">       * Compiler doesn't create read/write entities for create table.</span></span><br><span class="line"><span class="comment">       * Hence we need extract dbname from db.tab format, if applicable</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      currTab = extractTable((ASTNode)ast.getChild(<span class="number">0</span>));</span><br><span class="line">      currDB = extractDatabase((ASTNode)ast.getChild(<span class="number">0</span>));</span><br><span class="line">      <span class="comment">// 解析sql中的分区</span></span><br><span class="line">      partitionURI = extractPartition(ast);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_CREATEFUNCTION:</span><br><span class="line">      String udfClassName = BaseSemanticAnalyzer.unescapeSQLString(ast.getChild(<span class="number">1</span>).getText());</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        CodeSource udfSrc =</span><br><span class="line">            Class.forName(udfClassName, <span class="keyword">true</span>, Utilities.getSessionSpecifiedClassLoader())</span><br><span class="line">                .getProtectionDomain().getCodeSource();</span><br><span class="line">        <span class="keyword">if</span> (udfSrc == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> SemanticException(<span class="string">"Could not resolve the jar for UDF class "</span> + udfClassName);</span><br><span class="line">        &#125;</span><br><span class="line">        String udfJar = udfSrc.getLocation().getPath();</span><br><span class="line">        <span class="keyword">if</span> (udfJar == <span class="keyword">null</span> || udfJar.isEmpty()) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> SemanticException(<span class="string">"Could not find the jar for UDF class "</span> + udfClassName +</span><br><span class="line">              <span class="string">"to validate privileges"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        udfURIs.add(parseURI(udfSrc.getLocation().toString(), <span class="keyword">true</span>));</span><br><span class="line">      &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        List&lt;String&gt; functionJars = getFunctionJars(ast);</span><br><span class="line">        <span class="keyword">if</span> (functionJars.isEmpty()) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> SemanticException(<span class="string">"Error retrieving udf class:"</span> + e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// Add the jars from the command "Create function using jar" to the access list</span></span><br><span class="line">          <span class="comment">// Defer to hive to check if the class is in the jars</span></span><br><span class="line">          <span class="keyword">for</span>(String jar : functionJars) &#123;</span><br><span class="line">            udfURIs.add(parseURI(jar, <span class="keyword">false</span>));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// create/drop function is allowed with any database</span></span><br><span class="line">      currDB = Database.ALL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_DROPFUNCTION:</span><br><span class="line">      <span class="comment">// create/drop function is allowed with any database</span></span><br><span class="line">      currDB = Database.ALL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_LOAD:</span><br><span class="line">      String dbName = BaseSemanticAnalyzer.unescapeIdentifier(ast.getChild(<span class="number">1</span>).getChild(<span class="number">0</span>).getChild(<span class="number">0</span>).getText());</span><br><span class="line">      currDB = <span class="keyword">new</span> Database(dbName);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_DESCTABLE:</span><br><span class="line">      currDB = getCanonicalDb();</span><br><span class="line">      <span class="comment">// For DESCRIBE FORMATTED/EXTENDED ast will have an additional child node with value</span></span><br><span class="line">      <span class="comment">// "FORMATTED/EXTENDED".</span></span><br><span class="line">      isDescTableBasic = (ast.getChildCount() == <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_TRUNCATETABLE:</span><br><span class="line">      <span class="comment">// SENTRY-826:</span></span><br><span class="line">      <span class="comment">// Truncate empty partitioned table should throw SemanticException only if the</span></span><br><span class="line">      <span class="comment">// user does not have permission.</span></span><br><span class="line">      <span class="comment">// In postAnalyze, currOutDB and currOutTbl will be added into outputHierarchy</span></span><br><span class="line">      <span class="comment">// which will be validated in the hiveAuthzBinding.authorize method.</span></span><br><span class="line">      Preconditions.checkArgument(ast.getChildCount() == <span class="number">1</span>);</span><br><span class="line">      <span class="comment">// childcount is 1 for table without partition, 2 for table with partitions</span></span><br><span class="line">      Preconditions.checkArgument(ast.getChild(<span class="number">0</span>).getChildCount() &gt;= <span class="number">1</span>);</span><br><span class="line">      ASTNode tableTok = (ASTNode) ast.getChild(<span class="number">0</span>).getChild(<span class="number">0</span>);</span><br><span class="line">      Preconditions.checkArgument(tableTok.getChildCount() &gt;= <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (tableTok.getChildCount() == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// If tableTok chilcount is 1, tableTok does not has database information, use current working DB</span></span><br><span class="line">        currOutDB = extractDatabase((ASTNode) ast.getChild(<span class="number">0</span>));</span><br><span class="line">        currOutTab = extractTable((ASTNode) tableTok.getChild(<span class="number">0</span>));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// If tableTok has fully-qualified name(childcount is 2),</span></span><br><span class="line">        <span class="comment">// get the db and table information from tableTok.</span></span><br><span class="line">        extractDbTableNameFromTOKTABLE(tableTok);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> HiveParser.TOK_ALTERTABLE:</span><br><span class="line">    currDB = getCanonicalDb();</span><br><span class="line">    <span class="keyword">for</span> (Node childNode : ast.getChildren()) &#123;</span><br><span class="line">      ASTNode childASTNode = (ASTNode) childNode;</span><br><span class="line">      <span class="keyword">if</span> (<span class="string">"TOK_ALTERTABLE_SERIALIZER"</span>.equals(childASTNode.getText())) &#123;</span><br><span class="line">        ASTNode serdeNode = (ASTNode) childASTNode.getChild(<span class="number">0</span>);</span><br><span class="line">        String serdeClassName = BaseSemanticAnalyzer.unescapeSQLString(serdeNode.getText());</span><br><span class="line">        setSerdeURI(serdeClassName);</span><br><span class="line">      &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"TOK_ALTERTABLE_RENAME"</span>.equals(childASTNode.getText())) &#123;</span><br><span class="line">        currDB = extractDatabase((ASTNode)ast.getChild(<span class="number">0</span>));</span><br><span class="line">        ASTNode newTableNode = (ASTNode)childASTNode.getChild(<span class="number">0</span>);</span><br><span class="line">        currOutDB = extractDatabase(newTableNode);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    currDB = getCanonicalDb();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ast;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="postAnalyze"><a href="#postAnalyze" class="headerlink" title="postAnalyze"></a>postAnalyze</h4><p>下面是postAnalyze方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postAnalyze</span><span class="params">(HiveSemanticAnalyzerHookContext context,</span></span></span><br><span class="line"><span class="function"><span class="params">    List&lt;Task&lt;? extends Serializable&gt;&gt; rootTasks)</span> <span class="keyword">throws</span> SemanticException </span>&#123;</span><br><span class="line">  <span class="comment">// 获取stmt的操作类型</span></span><br><span class="line">  HiveOperation stmtOperation = getCurrentHiveStmtOp();</span><br><span class="line">  <span class="comment">// inputPrivileges（操作对应的输入路径）, outputPrivileges（操作对应的输出路径）, operationType（DDL、DML、QUERY等操作的类型）, operationScope（库、表、列、函数等）</span></span><br><span class="line">  HiveAuthzPrivileges stmtAuthObject;</span><br><span class="line">  <span class="comment">// 根据操作的类型获取当前这种操作必须要具备的权限，这并不需要RPC调用来获取用户的权限，而仅仅是获取这种操作需要具备的权限，主题是操作而不是用户</span></span><br><span class="line">  stmtAuthObject = HiveAuthzPrivilegesMap.getHiveAuthzPrivileges(stmtOperation);</span><br><span class="line">  <span class="comment">// must occur above the null check on stmtAuthObject</span></span><br><span class="line">  <span class="comment">// TODO 授权、取消并不是在binding模块中认证的？？？？ since GRANT/REVOKE/etc are not authorized by binding layer at present</span></span><br><span class="line">  <span class="comment">// subject包装用户信息</span></span><br><span class="line">  Subject subject = getCurrentSubject(context);</span><br><span class="line">  <span class="comment">// 直接从配置文件中获取用户所属的组的信息，因此可以猜测用户和组的映射的关系并不是在sentry的表中的，而是存在于配置文件中（查看表信息确实如此）</span></span><br><span class="line">  Set&lt;String&gt; subjectGroups = hiveAuthzBinding.getGroups(subject);</span><br><span class="line">  <span class="keyword">for</span> (Task&lt;? extends Serializable&gt; task : rootTasks) &#123;</span><br><span class="line">    <span class="keyword">if</span> (task <span class="keyword">instanceof</span> SentryGrantRevokeTask) &#123;</span><br><span class="line">      <span class="comment">// 应该是将原来的无权限的task包装成新的task，该task内部执行授权、取消授权的操作</span></span><br><span class="line">      SentryGrantRevokeTask sentryTask = (SentryGrantRevokeTask)task;</span><br><span class="line">      sentryTask.setHiveAuthzBinding(hiveAuthzBinding);</span><br><span class="line">      sentryTask.setAuthzConf(authzConf);</span><br><span class="line">      sentryTask.setSubject(subject);</span><br><span class="line">      sentryTask.setSubjectGroups(subjectGroups);</span><br><span class="line">      sentryTask.setIpAddress(context.getIpAddress());</span><br><span class="line">      sentryTask.setOperation(stmtOperation);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (stmtAuthObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// We don't handle authorizing this statement</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Replace DDLTask using the SentryFilterDDLTask for protection,</span></span><br><span class="line"><span class="comment">     * such as "show column" only allow show some column that user can access to.</span></span><br><span class="line"><span class="comment">     * SENTRY-847</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rootTasks.size(); i++) &#123;</span><br><span class="line">      Task&lt;? extends Serializable&gt; task = rootTasks.get(i);</span><br><span class="line">      <span class="keyword">if</span> (task <span class="keyword">instanceof</span> DDLTask) &#123;</span><br><span class="line">        ShowColumnsDesc showCols = ((DDLTask) task).getWork().getShowColumnsDesc();</span><br><span class="line">        <span class="keyword">if</span> (showCols != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// 针对DDL操作，这里是只展示用于具备权限的列</span></span><br><span class="line">          SentryFilterDDLTask filterTask =</span><br><span class="line">                  <span class="keyword">new</span> SentryFilterDDLTask(hiveAuthzBinding, subject, stmtOperation);</span><br><span class="line">          filterTask.copyDDLTask((DDLTask) task);</span><br><span class="line">          rootTasks.set(i, filterTask);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 最后进行鉴权，此处会远程调用来获取用户的权限</span></span><br><span class="line">    authorizeWithHiveBindings(context, stmtAuthObject, stmtOperation);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (AuthorizationException e) &#123;</span><br><span class="line">    executeOnFailureHooks(context, stmtOperation, e);</span><br><span class="line">    String permsRequired = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span> (String perm : hiveAuthzBinding.getLastQueryPrivilegeErrors()) &#123;</span><br><span class="line">      permsRequired += perm + <span class="string">";"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    SessionState.get().getConf().set(HiveAuthzConf.HIVE_SENTRY_AUTH_ERRORS, permsRequired);</span><br><span class="line">    String msgForLog = HiveAuthzConf.HIVE_SENTRY_PRIVILEGE_ERROR_MESSAGE</span><br><span class="line">        + <span class="string">"\n Required privileges for this query: "</span></span><br><span class="line">        + permsRequired;</span><br><span class="line">    String msgForConsole = HiveAuthzConf.HIVE_SENTRY_PRIVILEGE_ERROR_MESSAGE + <span class="string">"\n "</span></span><br><span class="line">        + e.getMessage()+ <span class="string">"\n The required privileges: "</span> + permsRequired;</span><br><span class="line">    <span class="comment">// AuthorizationException is not a real exception, use the info level to record this.</span></span><br><span class="line">    LOG.info(msgForLog);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> SemanticException(msgForConsole, e);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    hiveAuthzBinding.close();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">"true"</span>.equalsIgnoreCase(context.getConf().</span><br><span class="line">      get(HiveAuthzConf.HIVE_SENTRY_MOCK_COMPILATION))) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> SemanticException(HiveAuthzConf.HIVE_SENTRY_MOCK_ERROR + <span class="string">" Mock query compilation aborted. Set "</span> +</span><br><span class="line">        HiveAuthzConf.HIVE_SENTRY_MOCK_COMPILATION + <span class="string">" to 'false' for normal query processing"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面最后调用了authorizeWithHiveBindings方法，这里才是权限校验的地方，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">authorizeWithHiveBindings</span><span class="params">(HiveSemanticAnalyzerHookContext context,</span></span></span><br><span class="line"><span class="function"><span class="params">    HiveAuthzPrivileges stmtAuthObject, HiveOperation stmtOperation)</span> <span class="keyword">throws</span>  AuthorizationException </span>&#123;</span><br><span class="line">  <span class="comment">// 获取当前操作输入、输出相关的信息</span></span><br><span class="line">  Set&lt;ReadEntity&gt; inputs = context.getInputs();</span><br><span class="line">  Set&lt;WriteEntity&gt; outputs = context.getOutputs();</span><br><span class="line">  List&lt;List&lt;DBModelAuthorizable&gt;&gt; inputHierarchy = <span class="keyword">new</span> ArrayList&lt;List&lt;DBModelAuthorizable&gt;&gt;();</span><br><span class="line">  List&lt;List&lt;DBModelAuthorizable&gt;&gt; outputHierarchy = <span class="keyword">new</span> ArrayList&lt;List&lt;DBModelAuthorizable&gt;&gt;();</span><br><span class="line">  <span class="keyword">if</span>(LOG.isDebugEnabled()) &#123;</span><br><span class="line">    LOG.debug(<span class="string">"stmtAuthObject.getOperationScope() = "</span> + stmtAuthObject.getOperationScope());</span><br><span class="line">    LOG.debug(<span class="string">"context.getInputs() = "</span> + context.getInputs());</span><br><span class="line">    LOG.debug(<span class="string">"context.getOutputs() = "</span> + context.getOutputs());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Workaround to allow DESCRIBE &lt;table&gt; to be executed with only column-level privileges, while</span></span><br><span class="line">  <span class="comment">// still authorizing DESCRIBE [EXTENDED|FORMATTED] as table-level.</span></span><br><span class="line">  <span class="comment">// This is done by treating DESCRIBE &lt;table&gt; the same as SHOW COLUMNS, which only requires column</span></span><br><span class="line">  <span class="comment">// level privs.</span></span><br><span class="line">  <span class="keyword">if</span> (isDescTableBasic) &#123;</span><br><span class="line">    stmtAuthObject = HiveAuthzPrivilegesMap.getHiveAuthzPrivileges(HiveOperation.SHOWCOLUMNS);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 根据操作的对象提取对象的信息，分别存放到输入、输出的认证模型中</span></span><br><span class="line">  <span class="keyword">switch</span> (stmtAuthObject.getOperationScope()) &#123;</span><br><span class="line">  <span class="keyword">case</span> SERVER :</span><br><span class="line">    <span class="comment">// validate server level privileges if applicable. Eg create UDF,register jar etc ..</span></span><br><span class="line">    List&lt;DBModelAuthorizable&gt; serverHierarchy = <span class="keyword">new</span> ArrayList&lt;DBModelAuthorizable&gt;();</span><br><span class="line">    serverHierarchy.add(hiveAuthzBinding.getAuthServer());</span><br><span class="line">    inputHierarchy.add(serverHierarchy);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> DATABASE:</span><br><span class="line">    <span class="comment">// workaround for database scope statements (create/alter/drop db)</span></span><br><span class="line">    List&lt;DBModelAuthorizable&gt; dbHierarchy = <span class="keyword">new</span> ArrayList&lt;DBModelAuthorizable&gt;();</span><br><span class="line">    dbHierarchy.add(hiveAuthzBinding.getAuthServer());</span><br><span class="line">    dbHierarchy.add(currDB);</span><br><span class="line">    inputHierarchy.add(dbHierarchy);</span><br><span class="line">    <span class="keyword">if</span> (currOutDB != <span class="keyword">null</span>) &#123;</span><br><span class="line">      List&lt;DBModelAuthorizable&gt; outputDbHierarchy = <span class="keyword">new</span> ArrayList&lt;DBModelAuthorizable&gt;();</span><br><span class="line">      outputDbHierarchy.add(hiveAuthzBinding.getAuthServer());</span><br><span class="line">      outputDbHierarchy.add(currOutDB);</span><br><span class="line">      outputHierarchy.add(outputDbHierarchy);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      outputHierarchy.add(dbHierarchy);</span><br><span class="line">    &#125;</span><br><span class="line">    getInputHierarchyFromInputs(inputHierarchy, inputs);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> TABLE:</span><br><span class="line">    <span class="comment">// workaround for add partitions</span></span><br><span class="line">    <span class="keyword">if</span>(partitionURI != <span class="keyword">null</span>) &#123;</span><br><span class="line">      inputHierarchy.add(ImmutableList.of(hiveAuthzBinding.getAuthServer(), partitionURI));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(indexURI != <span class="keyword">null</span>) &#123;</span><br><span class="line">      outputHierarchy.add(ImmutableList.of(hiveAuthzBinding.getAuthServer(), indexURI));</span><br><span class="line">    &#125;</span><br><span class="line">    getInputHierarchyFromInputs(inputHierarchy, inputs);</span><br><span class="line">    <span class="keyword">for</span> (WriteEntity writeEntity: outputs) &#123;</span><br><span class="line">      <span class="keyword">if</span> (filterWriteEntity(writeEntity)) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      List&lt;DBModelAuthorizable&gt; entityHierarchy = <span class="keyword">new</span> ArrayList&lt;DBModelAuthorizable&gt;();</span><br><span class="line">      entityHierarchy.add(hiveAuthzBinding.getAuthServer());</span><br><span class="line">      entityHierarchy.addAll(getAuthzHierarchyFromEntity(writeEntity));</span><br><span class="line">      outputHierarchy.add(entityHierarchy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// workaround for metadata queries.</span></span><br><span class="line">    <span class="comment">// Capture the table name in pre-analyze and include that in the input entity list</span></span><br><span class="line">    <span class="keyword">if</span> (currTab != <span class="keyword">null</span>) &#123;</span><br><span class="line">      List&lt;DBModelAuthorizable&gt; externalAuthorizableHierarchy = <span class="keyword">new</span> ArrayList&lt;DBModelAuthorizable&gt;();</span><br><span class="line">      externalAuthorizableHierarchy.add(hiveAuthzBinding.getAuthServer());</span><br><span class="line">      externalAuthorizableHierarchy.add(currDB);</span><br><span class="line">      externalAuthorizableHierarchy.add(currTab);</span><br><span class="line">      inputHierarchy.add(externalAuthorizableHierarchy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// workaround for DDL statements</span></span><br><span class="line">    <span class="comment">// Capture the table name in pre-analyze and include that in the output entity list</span></span><br><span class="line">    <span class="keyword">if</span> (currOutTab != <span class="keyword">null</span>) &#123;</span><br><span class="line">      List&lt;DBModelAuthorizable&gt; externalAuthorizableHierarchy = <span class="keyword">new</span> ArrayList&lt;DBModelAuthorizable&gt;();</span><br><span class="line">      externalAuthorizableHierarchy.add(hiveAuthzBinding.getAuthServer());</span><br><span class="line">      externalAuthorizableHierarchy.add(currOutDB);</span><br><span class="line">      externalAuthorizableHierarchy.add(currOutTab);</span><br><span class="line">      outputHierarchy.add(externalAuthorizableHierarchy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> FUNCTION:</span><br><span class="line">    <span class="comment">/* The 'FUNCTION' privilege scope currently used for</span></span><br><span class="line"><span class="comment">     *  - CREATE TEMP FUNCTION</span></span><br><span class="line"><span class="comment">     *  - DROP TEMP FUNCTION.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!udfURIs.isEmpty()) &#123;</span><br><span class="line">      List&lt;DBModelAuthorizable&gt; udfUriHierarchy = <span class="keyword">new</span> ArrayList&lt;DBModelAuthorizable&gt;();</span><br><span class="line">      udfUriHierarchy.add(hiveAuthzBinding.getAuthServer());</span><br><span class="line">      udfUriHierarchy.addAll(udfURIs);</span><br><span class="line">      inputHierarchy.add(udfUriHierarchy);</span><br><span class="line">      <span class="keyword">for</span> (WriteEntity writeEntity : outputs) &#123;</span><br><span class="line">        List&lt;DBModelAuthorizable&gt; entityHierarchy = <span class="keyword">new</span> ArrayList&lt;DBModelAuthorizable&gt;();</span><br><span class="line">        entityHierarchy.add(hiveAuthzBinding.getAuthServer());</span><br><span class="line">        entityHierarchy.addAll(getAuthzHierarchyFromEntity(writeEntity));</span><br><span class="line">        outputHierarchy.add(entityHierarchy);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> CONNECT:</span><br><span class="line">    <span class="comment">/* The 'CONNECT' is an implicit privilege scope currently used for</span></span><br><span class="line"><span class="comment">     *  - USE &lt;db&gt;</span></span><br><span class="line"><span class="comment">     *  It's allowed when the user has any privilege on the current database. For application</span></span><br><span class="line"><span class="comment">     *  backward compatibility, we allow (optional) implicit connect permission on 'default' db.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;DBModelAuthorizable&gt; connectHierarchy = <span class="keyword">new</span> ArrayList&lt;DBModelAuthorizable&gt;();</span><br><span class="line">    connectHierarchy.add(hiveAuthzBinding.getAuthServer());</span><br><span class="line">    <span class="comment">// by default allow connect access to default db</span></span><br><span class="line">    Table currTbl = Table.ALL;</span><br><span class="line">    Column currCol = Column.ALL;</span><br><span class="line">    <span class="keyword">if</span> ((DEFAULT_DATABASE_NAME.equalsIgnoreCase(currDB.getName()) &amp;&amp;</span><br><span class="line">        <span class="string">"false"</span>.equalsIgnoreCase(authzConf.</span><br><span class="line">            get(HiveAuthzConf.AuthzConfVars.AUTHZ_RESTRICT_DEFAULT_DB.getVar(), <span class="string">"false"</span>)))) &#123;</span><br><span class="line">      currDB = Database.ALL;</span><br><span class="line">      currTbl = Table.SOME;</span><br><span class="line">    &#125;</span><br><span class="line">    connectHierarchy.add(currDB);</span><br><span class="line">    connectHierarchy.add(currTbl);</span><br><span class="line">    connectHierarchy.add(currCol);</span><br><span class="line">    inputHierarchy.add(connectHierarchy);</span><br><span class="line">    outputHierarchy.add(connectHierarchy);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> COLUMN:</span><br><span class="line">    <span class="keyword">for</span> (ReadEntity readEntity: inputs) &#123;</span><br><span class="line">      <span class="keyword">if</span> (readEntity.getAccessedColumns() != <span class="keyword">null</span> &amp;&amp; !readEntity.getAccessedColumns().isEmpty()) &#123;</span><br><span class="line">        addColumnHierarchy(inputHierarchy, readEntity);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        List&lt;DBModelAuthorizable&gt; entityHierarchy = <span class="keyword">new</span> ArrayList&lt;DBModelAuthorizable&gt;();</span><br><span class="line">        entityHierarchy.add(hiveAuthzBinding.getAuthServer());</span><br><span class="line">        entityHierarchy.addAll(getAuthzHierarchyFromEntity(readEntity));</span><br><span class="line">        entityHierarchy.add(Column.ALL);</span><br><span class="line">        inputHierarchy.add(entityHierarchy);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> AuthorizationException(<span class="string">"Unknown operation scope type "</span> +</span><br><span class="line">        stmtAuthObject.getOperationScope().toString());</span><br><span class="line">  &#125;</span><br><span class="line">  HiveAuthzBinding binding = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 这里比较关键，是通过远程调用获取用户的权限</span></span><br><span class="line">    binding = getHiveBindingWithPrivilegeCache(hiveAuthzBinding, context.getUserName());</span><br><span class="line">  &#125; <span class="keyword">catch</span> (SemanticException e) &#123;</span><br><span class="line">    <span class="comment">// Will use the original hiveAuthzBinding</span></span><br><span class="line">    binding = hiveAuthzBinding;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// validate permission</span></span><br><span class="line">  <span class="comment">// 最后一步验证权限</span></span><br><span class="line">  binding.authorize(stmtOperation, stmtAuthObject, getCurrentSubject(context), inputHierarchy,</span><br><span class="line">      outputHierarchy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于获取binding的会通过远程调用获取权限，因此有必要看一下这一步的操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> HiveAuthzBinding <span class="title">getHiveBindingWithPrivilegeCache</span><span class="params">(HiveAuthzBinding hiveAuthzBinding,</span></span></span><br><span class="line"><span class="function"><span class="params">    String userName)</span> <span class="keyword">throws</span> SemanticException </span>&#123;</span><br><span class="line">  <span class="comment">// get the original HiveAuthzBinding, and get the user's privileges by AuthorizationProvider</span></span><br><span class="line">  AuthorizationProvider authProvider = hiveAuthzBinding.getCurrentAuthProvider();</span><br><span class="line">  <span class="comment">// 这一步很关键，查看可以知道这一步会通过远程调用获取用户的权限</span></span><br><span class="line">  Set&lt;String&gt; userPrivileges = authProvider.getPolicyEngine().getPrivileges(</span><br><span class="line">          authProvider.getGroupMapping().getGroups(userName), hiveAuthzBinding.getActiveRoleSet(),</span><br><span class="line">          hiveAuthzBinding.getAuthServer());</span><br><span class="line">  <span class="comment">// create PrivilegeCache using user's privileges</span></span><br><span class="line">  <span class="comment">// 这一步主要是将之前获取到的权限数据缓存，便于在同一次会话中使用</span></span><br><span class="line">  PrivilegeCache privilegeCache = <span class="keyword">new</span> SimplePrivilegeCache(userPrivileges);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// create new instance of HiveAuthzBinding whose backend provider should be SimpleCacheProviderBackend</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HiveAuthzBinding(HiveAuthzBinding.HiveHook.HiveServer2, hiveAuthzBinding.getHiveConf(),</span><br><span class="line">            hiveAuthzBinding.getAuthzConf(), privilegeCache);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    LOG.error(<span class="string">"Can not create HiveAuthzBinding with privilege cache."</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> SemanticException(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至于最后一步权限的校验逻辑就不再赘述了，具体可以查看相应的代码。由上面的代码分析可以知道，
Hook这里实现了授权（SentryGrantRevokeTask）、鉴权（#getHiveBindingWithPrivilegeCache），
也即是用户的所有的请求都会被这一层拦截，并针对对象的类型执行相关的操作。client端的鉴权操作到此可以告一段落</p>
<h3 id="服务端鉴权操作"><a href="#服务端鉴权操作" class="headerlink" title="服务端鉴权操作"></a>服务端鉴权操作</h3><p>在client端鉴权操作的过程中我们看到了客户端会通过远程调用执行授权操作，也会通过远程调用执行鉴权操作，这个调用的过程是通过
RPC调用来实现的，
接下来我们看一下服务端的的操作，服务端的操作不止包含了鉴权和授权的操作，还包含了其他的操作，因此我们有必要先概要的介绍
一下服务端的操作，然后
详细的介绍一下鉴权和授权的操作。通过上面的整体架构图我们可以知道，服务端的入口在sentryService这个类中，主要的组成部
分如上图所示其中包含的模块和每一个模块的重要作用如下：</p>
<ul>
<li>thrift server：针对hook、listener发送过来的事件做相应的处理操作，处理的逻辑在sentryPolicyStoreProcessor</li>
<li>sentryWebServer：sentryService内置的一个基于jetty的webserver，有对应的界面：http://${sentry.server.url}:29000，查看了一下主要是一些配置信息和一些监控数据</li>
<li>sentryStore：（是一个单例）sentryStore在SentryService的构造函数中初始化的，初始化的时候有针对是否开启HDFS同步做检测。</li>
<li>leadMonitor：sentry开启高可用之后，用来监听leader变更的组件</li>
<li>HMSFollower：封装了hivemetastoreclient，用于从hivemetastore中同步hive相关的元数据</li>
</ul>
<p>接下来看一下sentryService的入口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  SentryKerberosContext kerberosContext = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    status = Status.STARTED;</span><br><span class="line">    <span class="keyword">if</span> (kerberos) &#123;</span><br><span class="line">      kerberosContext = <span class="keyword">new</span> SentryKerberosContext(principal, keytab, <span class="keyword">true</span>);</span><br><span class="line">      Subject.doAs(kerberosContext.getSubject(), <span class="keyword">new</span> PrivilegedExceptionAction&lt;Void&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">          runServer();</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      runServer();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception t) &#123;</span><br><span class="line">    LOGGER.error(<span class="string">"Error starting server"</span>, t);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Error starting server"</span>, t);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (kerberosContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">      kerberosContext.shutDown();</span><br><span class="line">    &#125;</span><br><span class="line">    status = Status.NOT_STARTED;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到call方法内仅仅是针对是否开启kerberos进行判断，最终入口都会调用runServer方法，跟进runServer方法来看一下：</p>
<p>1、首先会启动一些清理工作</p>
<p>2、接下来会启动HMSFollower，首先会获取metastore的thrifturi，然后会以500ms的周期定时调度，在hmsfollower构造函数中，会分别实例化
NotificationProcessor：用于处理notification，主要是针对DDL操作通过sentrystore持久化变更（这里会判断是否开启HDFS同步）。
SentryHMSClient：会首先获取sentryStore的notification的id，获取所有的库表信息（没有持久化），接下来再次获取notification的id，
如果两次获取到的id相同，说明在同步库表信息的过程中并没有新的DDL操作，这就表示已经完成同步操作。如果两次notification的id不同，
说明同步库表信息的时候有DDL操作，这个时候只需要继续同步即可。
HiveNotificationFetcher：会使用sentryHMSClient获取notification</p>
<p>3、接下来会构建thrift server，thrift server包含了processor逻辑（用于处理RPC请求，这里主要是权限的一些校验）
和sentrystore（持久化）的逻辑，之后启动sentryService的服务端来处理客户端的请求</p>
<p>4、然后启动sentryWebServer，这里主要是一些配置信息的查看和内置的一些监控数据
<img src="//southrivers.github.io/2019/11/23/sentry学习总结/webserver.png" alt>
上面的鉴权、授权的主要的业务逻辑是在thriftserver的processor中，对应的实现类为：SentryPolicyStoreProcessor，
我们可以具体查看一下相关的逻辑，下面是该类中包含的方法：
<img src="//southrivers.github.io/2019/11/23/sentry学习总结/thriftserver.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TCreateSentryRoleResponse <span class="title">create_sentry_role</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TCreateSentryRoleRequest request)</span> <span class="keyword">throws</span> TException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Timer.Context timerContext = sentryMetrics.createRoleTimer.time();</span><br><span class="line">  TCreateSentryRoleResponse response = <span class="keyword">new</span> TCreateSentryRoleResponse();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    validateClientVersion(request.getProtocol_version());</span><br><span class="line">    <span class="comment">// 校验当前用户的权限，创建角色是特殊的权限，需要用户所在的group和admin所在的group存在交集，如果不满足要求会抛出异常</span></span><br><span class="line">    authorize(request.getRequestorUserName(),</span><br><span class="line">        getRequestorGroups(request.getRequestorUserName()));</span><br><span class="line">    <span class="comment">// 将对应的角色持久化到sentry的数据库中</span></span><br><span class="line">    sentryStore.createSentryRole(request.getRoleName());</span><br><span class="line">    response.setStatus(Status.OK());</span><br><span class="line">    <span class="comment">// 责任链模式的业务，功能未知</span></span><br><span class="line">    notificationHandlerInvoker.create_sentry_role(request, response);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (SentryAlreadyExistsException e) &#123;</span><br><span class="line">    String msg = <span class="string">"Role: "</span> + request + <span class="string">" already exists."</span>;</span><br><span class="line">    LOGGER.error(msg, e);</span><br><span class="line">    response.setStatus(Status.AlreadyExists(e.getMessage(), e));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (SentryAccessDeniedException e) &#123;</span><br><span class="line">    LOGGER.error(e.getMessage(), e);</span><br><span class="line">    response.setStatus(Status.AccessDenied(e.getMessage(), e));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (SentryThriftAPIMismatchException e) &#123;</span><br><span class="line">    LOGGER.error(e.getMessage(), e);</span><br><span class="line">    response.setStatus(Status.THRIFT_VERSION_MISMATCH(e.getMessage(), e));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    String msg = <span class="string">"Unknown error for request: "</span> + request + <span class="string">", message: "</span> + e.getMessage();</span><br><span class="line">    LOGGER.error(msg, e);</span><br><span class="line">    response.setStatus(Status.RuntimeError(msg, e));</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    timerContext.stop();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    AUDIT_LOGGER.info(JsonLogEntityFactory.getInstance()</span><br><span class="line">        .createJsonLogEntity(request, response, conf).toJsonFormatLog());</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="comment">// if any exception, log the exception.</span></span><br><span class="line">    String msg = <span class="string">"Error creating audit log for create role: "</span> + e.getMessage();</span><br><span class="line">    LOGGER.error(msg, e);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码核心代码只有三行，我们已经对其进行标注，其他的业务处理流程类似，具体可以查看相关的代码，这里不再赘述。</p>
<h2 id="表变更事件同步"><a href="#表变更事件同步" class="headerlink" title="表变更事件同步"></a>表变更事件同步</h2><p>client端触发notification的地方是SentrySyncHMSNotificationsPostEventListener这个类，如下：
上面这些方法在监听到特定的事件的时候会触发notification，查看hive的metastore对应的数据库发现有针
对notification的记录，如下为监听到特定事件之后的client的触发机制：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">syncNotificationEvents</span><span class="params">(ListenerEvent event, String eventName)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Do not sync notifications if the event has failed.</span></span><br><span class="line">  <span class="keyword">if</span> (failedEvent(event, eventName)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Map&lt;String, String&gt; eventParameters = event.getParameters();</span><br><span class="line">  <span class="keyword">if</span> (!eventParameters.containsKey(MetaStoreEventListenerConstants.DB_NOTIFICATION_EVENT_ID_KEY_NAME)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* If the HMS is running in an active transaction, then we do not want to sync with Sentry</span></span><br><span class="line"><span class="comment">   * because the desired eventId is not available for Sentry yet, and Sentry may block the HMS</span></span><br><span class="line"><span class="comment">   * forever or until a read time-out happens. */</span></span><br><span class="line">  <span class="keyword">if</span> (isMetastoreTransactionActive(eventParameters)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">long</span> eventId =</span><br><span class="line">      Long.parseLong(eventParameters.get(MetaStoreEventListenerConstants.DB_NOTIFICATION_EVENT_ID_KEY_NAME));</span><br><span class="line">  <span class="comment">// This check is only for performance reasons to avoid calling the sync thrift call if the Sentry server</span></span><br><span class="line">  <span class="comment">// already processed the requested eventId.</span></span><br><span class="line">  <span class="keyword">if</span> (eventId &lt;= latestProcessedId.get()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 上面是对event的合法性做的校验，可以不用关心</span></span><br><span class="line">  <span class="keyword">try</span>(SentryPolicyServiceClient sentryClient = <span class="keyword">this</span>.getSentryServiceClient()) &#123;</span><br><span class="line">    LOGGER.debug(<span class="string">"Starting Sentry/HMS notifications sync for &#123;&#125; (id: &#123;&#125;)"</span>, eventName, eventId);</span><br><span class="line">        <span class="comment">// 将最新的notificationId通知到服务端</span></span><br><span class="line">    <span class="keyword">long</span> sentryLatestProcessedId = sentryClient.syncNotifications(eventId);</span><br><span class="line">    LOGGER.debug(<span class="string">"Finishedd Sentry/HMS notifications sync for &#123;&#125; (id: &#123;&#125;)"</span>, eventName, eventId);</span><br><span class="line">    LOGGER.debug(<span class="string">"Latest processed event ID returned by the Sentry server: &#123;&#125;"</span>, sentryLatestProcessedId);</span><br><span class="line">        <span class="comment">// 更新本地的latestProcessedId，默认的情况下，在client启动的时候latestProcessedId是0</span></span><br><span class="line">    updateProcessedId(sentryLatestProcessedId);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="comment">// This error is only logged. There is no need to throw an error to Hive because HMS sync is called</span></span><br><span class="line">    <span class="comment">// after the notification is already generated by Hive (as post-event).</span></span><br><span class="line">    LOGGER.error(<span class="string">"Failed to sync requested HMS notifications up to the event ID: "</span> + eventId, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如下，还是在SentryPolicyStoreProcessor这个类中，服务端会对客户端发过来的消息进行处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TSentrySyncIDResponse <span class="title">sentry_sync_notifications</span><span class="params">(TSentrySyncIDRequest request)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> TException </span>&#123;</span><br><span class="line">  TSentrySyncIDResponse response = <span class="keyword">new</span> TSentrySyncIDResponse();</span><br><span class="line">  <span class="keyword">try</span> (Timer.Context timerContext = hmsWaitTimer.time()) &#123;</span><br><span class="line">    <span class="comment">// Wait until Sentry Server processes specified HMS Notification ID.</span></span><br><span class="line">        <span class="comment">// 阻塞服务端，直至处理完该notification</span></span><br><span class="line">    response.setId(sentryStore.getCounterWait().waitFor(request.getId()));</span><br><span class="line">    response.setStatus(Status.OK());</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    String msg = String.format(<span class="string">"wait request for id %d is interrupted"</span>,</span><br><span class="line">            request.getId());</span><br><span class="line">    LOGGER.error(msg, e);</span><br><span class="line">    response.setId(<span class="number">0</span>);</span><br><span class="line">    response.setStatus(Status.RuntimeError(msg, e));</span><br><span class="line">    Thread.currentThread().interrupt();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">    String msg = String.format(<span class="string">"timed out wait request for id %d"</span>, request.getId());</span><br><span class="line">    LOGGER.warn(msg, e);</span><br><span class="line">    response.setId(<span class="number">0</span>);</span><br><span class="line">    response.setStatus(Status.RuntimeError(msg, e));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心代码只有一行，我们看到在sentryStore中包含了一个counterWaiter，该变量会用在thriftserver和hmsfollower同步notification，
存放在sentryStore并不合适，只不过sentryStore是thriftserver和hmsfollower唯一的纽带，后面可能会调整。
在上面的代码中，通过counterWaiter实现了notification的发布机制，真正的处理逻辑在hmsfollower中，
因此我们接下来看一下hmsfollower是怎么处理这些事件的。Hmsfollower的构造函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HMSFollower</span><span class="params">(Configuration conf, SentryStore store, LeaderStatusMonitor leaderMonitor,</span></span></span><br><span class="line"><span class="function"><span class="params">            HiveConnectionFactory hiveConnectionFactory, String authServerName)</span> </span>&#123;</span><br><span class="line">  LOGGER.info(<span class="string">"HMSFollower is being initialized"</span>);</span><br><span class="line">  readyToServe = <span class="keyword">false</span>;</span><br><span class="line">  authzConf = conf;</span><br><span class="line">  <span class="keyword">this</span>.leaderMonitor = leaderMonitor;</span><br><span class="line">  sentryStore = store;</span><br><span class="line">  <span class="keyword">if</span> (authServerName == <span class="keyword">null</span>) &#123;</span><br><span class="line">    authServerName = conf.get(AUTHZ_SERVER_NAME.getVar(),</span><br><span class="line">      conf.get(AUTHZ_SERVER_NAME_DEPRECATED.getVar(), AUTHZ_SERVER_NAME_DEPRECATED.getDefault()));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 用于处理从hive metastore接收到的数据</span></span><br><span class="line">  notificationProcessor = <span class="keyword">new</span> NotificationProcessor(sentryStore, authServerName, authzConf);</span><br><span class="line">  <span class="comment">// 包装了hiveMetaStore的客户端，用于从hive元数据仓库获取相应的数据</span></span><br><span class="line">  client = <span class="keyword">new</span> SentryHMSClient(authzConf, hiveConnectionFactory);</span><br><span class="line">  hdfsSyncEnabled = SentryServiceUtil.isHDFSSyncEnabledNoCache(authzConf); <span class="comment">// no cache to test different settings for hdfs sync</span></span><br><span class="line">  <span class="comment">// 使用封装的client获取相应的数据</span></span><br><span class="line">  notificationFetcher = <span class="keyword">new</span> HiveNotificationFetcher(sentryStore, hiveConnectionFactory);</span><br><span class="line">  <span class="comment">// subscribe to full update notification</span></span><br><span class="line">  <span class="keyword">if</span> (conf.getBoolean(ServerConfig.SENTRY_SERVICE_FULL_UPDATE_PUBSUB, <span class="keyword">false</span>)) &#123;</span><br><span class="line">    LOGGER.info(FULL_UPDATE_TRIGGER + <span class="string">"subscribing to topic "</span> + PubSub.Topic.HDFS_SYNC_HMS.getName());</span><br><span class="line">    PubSub.getInstance().subscribe(PubSub.Topic.HDFS_SYNC_HMS, <span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比较重要的地方都已经用中文注释，从名字可以大致看出来notificationFetcher是用来从hive的metastore中拉取notification的，notificationProcessor是用来处理获取到的notification的。 
由于hms是定时调度的，因此我们可以通过定时调度的方法作为入口来分析hmsfollower，对应的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 用于发布HMSFollower的状态</span></span><br><span class="line">  SentryStateBank.enableState(HMSFollowerState.COMPONENT,HMSFollowerState.STARTED);</span><br><span class="line">  <span class="keyword">long</span> lastProcessedNotificationId;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// Initializing lastProcessedNotificationId based on the latest persisted notification ID.</span></span><br><span class="line">      lastProcessedNotificationId = sentryStore.getLastProcessedNotificationID();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      LOGGER.error(<span class="string">"Failed to get the last processed notification id from sentry store, "</span></span><br><span class="line">          + <span class="string">"Skipping the processing"</span>, e);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Wake any clients connected to this service waiting for HMS already processed notifications.</span></span><br><span class="line">        <span class="comment">// 唤醒所有在lastProcessedNotificationId上等待的client，这里的client对应的是从hivemetastore同步数据的client（猜测）</span></span><br><span class="line">    wakeUpWaitingClientsForSync(lastProcessedNotificationId);</span><br><span class="line">    <span class="comment">// Only the leader should listen to HMS updates</span></span><br><span class="line">    <span class="keyword">if</span> (!isLeader()) &#123;</span><br><span class="line">      <span class="comment">// Close any outstanding connections to HMS</span></span><br><span class="line">      close();</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理新到达的notifications</span></span><br><span class="line">    syncupWithHms(lastProcessedNotificationId);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// 重置状态</span></span><br><span class="line">    SentryStateBank.disableState(HMSFollowerState.COMPONENT,HMSFollowerState.STARTED);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心的代码在syncupWithHms中，最终方法会调度到notificationProcessor.processNotificationEvent(event)，
进入该方法发现会针对特定的事件执行权限的变更操作，具体的代码如下： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (Context ignored = timer.time()) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (eventType) &#123;</span><br><span class="line">      <span class="keyword">case</span> CREATE_DATABASE:</span><br><span class="line">        <span class="keyword">return</span> processCreateDatabase(event);</span><br><span class="line">      <span class="keyword">case</span> DROP_DATABASE:</span><br><span class="line">        <span class="keyword">return</span> processDropDatabase(event);</span><br><span class="line">      <span class="keyword">case</span> CREATE_TABLE:</span><br><span class="line">        <span class="keyword">return</span> processCreateTable(event);</span><br><span class="line">      <span class="keyword">case</span> DROP_TABLE:</span><br><span class="line">        <span class="keyword">return</span> processDropTable(event);</span><br><span class="line">      <span class="keyword">case</span> ALTER_TABLE:</span><br><span class="line">        <span class="keyword">return</span> processAlterTable(event);</span><br><span class="line">      <span class="keyword">case</span> ADD_PARTITION:</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;       <span class="comment">// return processAddPartition(event);</span></span><br><span class="line">      <span class="keyword">case</span> DROP_PARTITION:</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;       <span class="comment">// return processDropPartition(event);</span></span><br><span class="line">      <span class="keyword">case</span> ALTER_PARTITION:</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;       <span class="comment">//return processAlterPartition(event);</span></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        LOGGER.error(<span class="string">"Notification with ID:&#123;&#125; has invalid event type: &#123;&#125;"</span>, event.getEventId(),</span><br><span class="line">            event.getEventType());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入到对应的方法查看，发现根据具体的事件同步的变更权限，如：删除数据库会把数据库相关的权限的数据都删除。在完成同步操作之后会记录到数据库中本次metastore的变更。</p>
<h2 id="Hdfs-namenode鉴权"><a href="#Hdfs-namenode鉴权" class="headerlink" title="Hdfs namenode鉴权"></a>Hdfs namenode鉴权</h2><h3 id="元数据同步"><a href="#元数据同步" class="headerlink" title="元数据同步"></a>元数据同步</h3><p>hdfs namenode会定期从sentry server中同步权限以及hive的元数据，程序的入口在SentryAuthorizationProvider，最终会通过SentryAuthorizationInfo定时更新authzPaths和authzPermissions，核心代码在类SentryAuthorizationInfo中，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">//Looks like getting same updates multiple times</span></span><br><span class="line">  SentryAuthzUpdate updates = updater.getUpdates();</span><br><span class="line">  <span class="comment">// Updates can be null if Sentry Service is un-reachable</span></span><br><span class="line">  <span class="keyword">if</span> (updates != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (updates.isEmpty()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// no updates is a norm, it's still success</span></span><br><span class="line">    &#125;</span><br><span class="line">    UpdateableAuthzPaths newAuthzPaths = processUpdates(</span><br><span class="line">        updates.getPathUpdates(), authzPaths);</span><br><span class="line">    UpdateableAuthzPermissions newAuthzPerms = processUpdates(</span><br><span class="line">        updates.getPermUpdates(), authzPermissions);</span><br><span class="line">    <span class="comment">// processUpdates() should return different newAuthzPaths and newAuthzPerms object references</span></span><br><span class="line">    <span class="comment">// if FULL updates were fetched from the Sentry server, otherwise, the same authzPaths and authzPermissions</span></span><br><span class="line">    <span class="comment">// objects will be returned.</span></span><br><span class="line">    <span class="keyword">if</span> (newAuthzPaths != authzPaths || newAuthzPerms != authzPermissions) &#123;</span><br><span class="line">      lock.writeLock().lock();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">          LOG.debug(updates.dumpContent());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (newAuthzPaths != authzPaths) &#123;</span><br><span class="line">          LOG.info(String.format(<span class="string">"FULL Updated paths seq Num [old=%d], [new=%d]"</span>,</span><br><span class="line">            authzPaths.getLastUpdatedSeqNum(), newAuthzPaths.getLastUpdatedSeqNum()));</span><br><span class="line">          authzPaths = newAuthzPaths;</span><br><span class="line">          <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">            LOG.trace(authzPaths.dumpContent());</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (newAuthzPerms != authzPermissions) &#123;</span><br><span class="line">          LOG.info(String.format(<span class="string">"FULL Updated perms seq Num [old=%d], [new=%d]"</span>,</span><br><span class="line">            authzPermissions.getLastUpdatedSeqNum(), newAuthzPerms.getLastUpdatedSeqNum()));</span><br><span class="line">          authzPermissions = newAuthzPerms;</span><br><span class="line">          <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">            LOG.trace(authzPermissions.dumpContent());</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.writeLock().unlock();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">        lock.writeLock().lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          LOG.debug(updates.dumpContent());</span><br><span class="line">          <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">            LOG.trace(newAuthzPaths.dumpContent());</span><br><span class="line">            LOG.trace(newAuthzPerms.dumpContent());</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          lock.writeLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，更新权限或者hive元数据的时候，会使用一个readwritelock来实现线程之间的同步，这一块应该是考虑让两个变量的同步更新。这一个锁在更新数据的时候会让其他的读操作阻塞，因此可能会产生性能瓶颈。</p>
<h3 id="鉴权操作"><a href="#鉴权操作" class="headerlink" title="鉴权操作"></a>鉴权操作</h3><p>hdfs鉴权操作在类SentryAuthorizationProvider中，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkPermission</span><span class="params">(String user, Set&lt;String&gt; groups,</span></span></span><br><span class="line"><span class="function"><span class="params">     INodeAuthorizationInfo[] inodes, <span class="keyword">int</span> snapshotId,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">boolean</span> doCheckOwner, FsAction ancestorAccess, FsAction parentAccess,</span></span></span><br><span class="line"><span class="function"><span class="params">     FsAction access, FsAction subAccess, <span class="keyword">boolean</span> ignoreEmptyDir)</span></span></span><br><span class="line"><span class="function">     <span class="keyword">throws</span> AccessControlException, UnresolvedLinkException </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">     <span class="comment">// Note: Arrays.asList() returns "[null]" string for null argument</span></span><br><span class="line">     LOG.debug(<span class="string">"### checkPermission(): "</span> +</span><br><span class="line">               <span class="string">"User &#123;&#125;, Groups &#123;&#125;, Nodes &#123;&#125;, snapshotId &#123;&#125;, "</span> +</span><br><span class="line">               <span class="string">"doCheckOwner &#123;&#125;, ancestorAccess &#123;&#125;, parentAccess &#123;&#125;, "</span> +</span><br><span class="line">               <span class="string">"access &#123;&#125;, subAccess &#123;&#125;, ignoreEmptyDir &#123;&#125;"</span>,</span><br><span class="line">       user, groups, Arrays.asList(inodes), snapshotId,</span><br><span class="line">       doCheckOwner, ancestorAccess, parentAccess,</span><br><span class="line">       access, subAccess, ignoreEmptyDir);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">   <span class="comment">//绕过原生NN鉴权过程对x权限的判断，DefaultAuthorizationProvider.checkPermission从跟节点逐级判断x权限</span></span><br><span class="line">   <span class="comment">//直接return表示鉴权成功，鉴权失败时会抛异常</span></span><br><span class="line">   <span class="comment">//http://km.vivo.xyz/pages/viewpage.action?pageId=85251073</span></span><br><span class="line">   <span class="keyword">if</span> (!doCheckOwner &amp;&amp; ancestorAccess == <span class="keyword">null</span> &amp;&amp; parentAccess == <span class="keyword">null</span> &amp;&amp; </span><br><span class="line">          access == <span class="keyword">null</span> &amp;&amp; subAccess == <span class="keyword">null</span> &amp;&amp; !ignoreEmptyDir) &#123;</span><br><span class="line">  <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">    LOG.debug(<span class="string">"### checkPermission() return: "</span> +</span><br><span class="line">              <span class="string">"User &#123;&#125;, Groups &#123;&#125;, Nodes &#123;&#125;, snapshotId &#123;&#125;, "</span> +</span><br><span class="line">              <span class="string">"doCheckOwner &#123;&#125;, ancestorAccess &#123;&#125;, parentAccess &#123;&#125;, "</span> +</span><br><span class="line">              <span class="string">"access &#123;&#125;, subAccess &#123;&#125;, ignoreEmptyDir &#123;&#125;"</span>,</span><br><span class="line">      user, groups, Arrays.asList(inodes), snapshotId,</span><br><span class="line">      doCheckOwner, ancestorAccess, parentAccess,</span><br><span class="line">      access, subAccess, ignoreEmptyDir);</span><br><span class="line">  &#125;</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//filter to check</span></span><br><span class="line">   <span class="comment">//过滤hive执行mr和spark任务产生的临时文件的鉴权</span></span><br><span class="line">   <span class="keyword">if</span> (isFilter(inodes, <span class="string">"checkPermission()"</span>)) &#123;</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="comment">//只进行一次鉴权</span></span><br><span class="line">  inodes = truncate(inodes, doCheckOwner, ancestorAccess, parentAccess);</span><br><span class="line">     <span class="keyword">if</span> (inodes.length == <span class="number">1</span> &amp;&amp; access == <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span> (subAccess != <span class="keyword">null</span>) &#123;</span><br><span class="line">         access = subAccess;</span><br><span class="line">         subAccess = <span class="keyword">null</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ancestorAccess != <span class="keyword">null</span>) &#123;</span><br><span class="line">         access = ancestorAccess;</span><br><span class="line">         ancestorAccess = <span class="keyword">null</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parentAccess != <span class="keyword">null</span>) &#123;</span><br><span class="line">         access = parentAccess;</span><br><span class="line">         parentAccess = <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">  LOG.warn(<span class="string">"### truncate Exception. "</span> +</span><br><span class="line">         <span class="string">"User &#123;"</span> + user + <span class="string">"&#125;, Groups &#123;"</span> + groups + <span class="string">"&#125;, Nodes &#123;"</span> + Arrays.asList(inodes) + <span class="string">"&#125;, snapshotId &#123;"</span> + snapshotId + <span class="string">"&#125;, "</span> + </span><br><span class="line">     <span class="string">"doCheckOwner &#123;"</span> + doCheckOwner + <span class="string">"&#125;, ancestorAccess &#123;"</span> + ancestorAccess + <span class="string">"&#125;, parentAccess &#123;"</span> + parentAccess + <span class="string">"&#125;, "</span> + </span><br><span class="line">         <span class="string">"access &#123;"</span> + access + <span class="string">"&#125;, subAccess &#123;"</span> + subAccess + <span class="string">"&#125;, ignoreEmptyDir &#123;"</span> + ignoreEmptyDir + <span class="string">"&#125;, FullPath &#123;"</span> + </span><br><span class="line">     (inodes[<span class="number">0</span>] == <span class="keyword">null</span> ? <span class="string">"null"</span> : inodes[<span class="number">0</span>].getFullPathName()) + <span class="string">"&#125; taken &#123;"</span> + (System.currentTimeMillis() - start) + <span class="string">"&#125;."</span>, e);</span><br><span class="line">&#125;</span><br><span class="line">   <span class="keyword">long</span> truncateTime = System.currentTimeMillis() - start;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     defaultAuthzProvider.checkPermission(user, groups, inodes, snapshotId,</span><br><span class="line">       doCheckOwner, ancestorAccess, parentAccess, access, subAccess,</span><br><span class="line">       ignoreEmptyDir);</span><br><span class="line">     <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">       LOG.debug(<span class="string">"### checkPermission(): "</span> +</span><br><span class="line">                 <span class="string">"User &#123;&#125;, Groups &#123;&#125;, Nodes &#123;&#125;, snapshotId &#123;&#125;, "</span> + </span><br><span class="line">                <span class="string">"doCheckOwner &#123;&#125;, ancestorAccess &#123;&#125;, parentAccess &#123;&#125;, "</span> + </span><br><span class="line">                 <span class="string">"access &#123;&#125;, subAccess &#123;&#125;, ignoreEmptyDir &#123;&#125;, FullPath &#123;&#125; taken &#123;&#125;, truncateTime &#123;&#125;"</span>,</span><br><span class="line">         user, groups, Arrays.asList(inodes), snapshotId,</span><br><span class="line">         doCheckOwner, ancestorAccess, parentAccess,</span><br><span class="line">         access, subAccess, ignoreEmptyDir, inodes[<span class="number">0</span>] == <span class="keyword">null</span> ? <span class="string">"null"</span> : inodes[<span class="number">0</span>].getFullPathName(), </span><br><span class="line">                (System.currentTimeMillis() - start), truncateTime);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (AccessControlException e) &#123;</span><br><span class="line">     LOG.debug(<span class="string">"### AccessControlException"</span>, e);</span><br><span class="line">     <span class="keyword">throw</span> e;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (UnresolvedLinkException e) &#123;</span><br><span class="line">     LOG.debug(<span class="string">"### UnresolvedLinkException"</span>, e);</span><br><span class="line">     <span class="keyword">throw</span> e;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">     LOG.error(<span class="string">"### Unexpected Exception"</span>, e);</span><br><span class="line">     <span class="keyword">throw</span> e;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中我们可以看到，最终是由于defaultAuthzProvider来进行权限的校验的，因此SentryAuthorizationProvider更多的像是一个门面。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>sentry权限的管控用到了hive的hook、listener机制，本质上就是一个切面操作，这里比较重要的，我个人认为应当是DDL、DML操作数据的提取，
这样如果在定制化权限控制的时候才可以做到较快的响应</p>

            
                

            
        </div>
        <div class="post-tool">
            <a class="btn-thumbs-up" href="javascript:void(0);" data-cid="52" title="95">
                <i class="fa fa-thumbs-up" aria-hidden="true"></i> 打赏
            </a>
        </div>
        
        <div class="post-tags">tags：
            
        </div>
        
    </article>
    
        <p style="text-align: center">本文代表个人观点，内容仅供参考</p>
    
    
    

</div>
<script src="/js/busuanzi.pure.mini.js"></script>


        </div><!-- end #main-->
    </div><!-- end #body -->
    <footer class="footer">
    <div class="footer-inner" style="text-align: center">

    </div>
</footer>
<script src="/js/SimpleCore.js"></script>

</div>
<!-- search pop -->
<div class="popup search-popup local-search-popup">
    <div class="local-search-header clearfix">
        <span class="search-icon">
            <i class="fa fa-search"></i>
        </span>
        <span class="popup-btn-close">
            <i class="fa fa-times-circle"></i>
        </span>
        <div class="local-search-input-wrapper">
            <input id="local-search-input" spellcheck="false" type="text" autocomplete="off" placeholder="请输入查询关键词">
        </div>
    </div>
    <div id="local-search-result"></div>
</div>
<div class="fixed-btn">
    <a class="btn-gotop" href="javascript:"> <i class="fa fa-angle-up"></i></a>
</div>
<script>
    $(function () {
        var jsi_config = {
            buildingTime: '01/20/2018',
            current: $('.post-tags').length > 0 ? 'post' : 'archive',
            snsQRCode: '/images/sns-qrcode.png',
            donateImg: '/images/donate-qr.png',
            localSearch: { dbPath: '' },
            readMode: 'day'
        };
        
            jsi_config.localSearch = {
                dbPath: '/search.xml',
                trigger: 'auto',
                topN: '1',
                unescape: 'false'
            }
        
        SimpleCore.init(jsi_config);
        
    });
</script>
</body>
</html>
