<!DOCTYPE HTML>
<html class="no-js" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--[if lte IE 9]>
<meta http-equiv="refresh" content="0;url=http://southrivers.github.io/warn.html">
<![endif]-->
<meta charset="utf-8">
<meta http-equiv="X-DNS-Prefetch-Control" content="on">
<link rel="dns-prefetch" href="http://southrivers.github.io">
<link rel="dns-prefetch" href="//www.google-analytics.com">
<link rel="prefetch" href="http://southrivers.github.io">
<link rel="prefetch" href="//www.google-analytics.com">


<link rel="prerender" href="http://southrivers.github.io">

<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
<meta http-equiv="mobile-agent" content="format=html5; url=http://southrivers.github.io">
<meta name="author" content="John Doe">
<link rel="stylesheet" href="/css/JSimple.css">

<link rel="shortcut icon" href="/images/favicon.png">


<title>sentryå­¦ä¹ æ€»ç»“ - ç¦»äº­ç‡•</title>

<meta name="keywords" content>

<meta name="description " content>

    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                processEscapes: true
            }
        });
    </script>


    

    

</head>
<body>
<div id="nav">
    <nav class="nav-menu">
        <a class="site-name current" href="/" title="å¤">å¤</a>
        <a class="site-index current" href="/"><i class="fa fa-home"></i><span>é¦–é¡µ</span></a>
        <a href="/archives" title="å½’æ¡£"><i class="fa fa-archives"></i><span>å½’æ¡£</span></a>

        <!-- custom single page of menus -->
        
    </nav>
</div>

<div class="nav-user">
    <a class="btn-search" href="#"><i class="fa fa-search"></i></a>
    <a class="btn-read-mode" href="#"><i class="fa fa-sun-o"></i></a>
    <a class="btn-sns-qr" href="javascript:"><i class="fa fa-telegram"></i></a>
</div>

<div id="wrapper" class="clearfix">
    <div id="body">
        <div class="main" id="main">
            <div id="cover">
    <div class="cover-img"></div>
    <div class="cover-info">
        
        <h1 class="cover-siteName">è¡€åˆ€è€ç¥–</h1>
        <h3 class="cover-siteTitle">ç ä¸ªè›‹</h3>
        <p class="cover-siteDesc">ä¸œé—¨é»„çŠ¬</p>
        <div class="cover-sns">
            

        </div>
    </div>
</div>

            <div class="page-title">
    <ul>
        <li><a href="/">æœ€è¿‘</a></li>
        

        
        <li class="page-search">
    <form id="search" class="search-form">
        <input type="text" readonly="readonly" id="local-search-input-tip" placeholder="è¯»ç‰©æ£€ç´¢~">
        <button type="button" disabled="disabled" class="search-form-submit"><i class="fa fa-search"></i></button>
    </form>
</li>

    </ul>
</div>
<div class="main-inner">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
        <div class="post-header">
            <div class="post-author clearfix">
                <a class="avatar fleft" href="http://southrivers.github.io" target="_blank">
                    <img width="48" src="/images/favicon.png" alt="avatar">
                </a>
                <p><span class="label">author</span>
                    <a href="http://southrivers.github.io" target="_blank">åŸç«™</a>
                    <span title="last_edited&nbsp;2019-11-23">2019-11-23</span>
                </p>
                <p>ç ä¸ªè›‹ï¸ï¸</p>
            </div>
            <h2 class="post-title">sentryå­¦ä¹ æ€»ç»“</h2>

        </div>
        <div class="post-content markdown-body">
            <h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>sentryæ˜¯å¤§æ•°æ®å®‰å…¨ç»„ä»¶ï¼Œç”¨äºç®¡æ§hiveã€hbaseç­‰ç»„ä»¶æƒé™çš„æ§åˆ¶ï¼Œåœ¨hadoop3.0ä¹‹åä½¿ç”¨åˆ°çš„å®‰å…¨ç»„ä»¶æ˜¯rangerï¼Œsentryå·²ç»åºŸå¼ƒï¼Œä¸è¿‡å¾ˆå¤šå¤§æ•°æ®å¹³å°
ç‰ˆæœ¬ä¾ç„¶æ˜¯2.xï¼Œè€Œä¸”è¿™ç§å®‰å…¨ç»„ä»¶åŸç†ä¹Ÿæ˜¯ç›¸é€šçš„ï¼Œå› æ­¤æœ‰å¿…è¦ç ”ç©¶ä¸€ä¸‹ï¼ˆä¸»è¦æ˜¯æœ€è¿‘è¢«åˆ†åˆ°äº†è¿™ä¸ªç»„ä»¶ï¼ŒğŸ˜„ï¼‰ï¼Œç”±äºåœ¨å·¥ç¨‹å®è·µä¸­æˆ‘ä»¬è¿™é‡Œæ›´å¤šçš„æ˜¯ä½¿ç”¨sentry
ç®¡æ§hiveçš„æƒé™ï¼Œå› æ­¤æœ‰å¿…è¦åœ¨ä»‹ç»sentryä¹‹å‰å¯¹hiveçš„ä½“ç³»ç»“æ„è¿›è¡Œè¯´æ˜ã€‚</p>
<h1 id="HIVEæ¦‚è¿°"><a href="#HIVEæ¦‚è¿°" class="headerlink" title="HIVEæ¦‚è¿°"></a>HIVEæ¦‚è¿°</h1><h2 id="HIVEæ¶æ„"><a href="#HIVEæ¶æ„" class="headerlink" title="HIVEæ¶æ„"></a>HIVEæ¶æ„</h2><p>å¦‚ä¸‹å›¾æ‰€ç¤ºä¸ºhiveçš„æ¶æ„ï¼š
<img src="//southrivers.github.io/2019/11/23/sentryå­¦ä¹ æ€»ç»“/hive%E6%9E%B6%E6%9E%84.png" alt></p>
<ul>
<li>UIï¼šhiveçš„å®¢æˆ·ç«¯ï¼ŒåŒ…å«äº†hiveCliã€beeLineï¼Œç”¨æˆ·é€šè¿‡UIæ¥å®ç°è‡ªå·±çš„æ“ä½œï¼ŒCliDriveræ˜¯SQLæœ¬åœ°ç›´æ¥ç¼–è¯‘ï¼Œç„¶åè®¿é—®metastoreï¼Œå¹¶æäº¤ä½œä¸šï¼Œæ˜¯é‡å®¢æˆ·ç«¯ï¼ŒBeeLineä¼šå°†SQLæäº¤ç»™Hive Server2ï¼Œç”±Hive server2ç¼–è¯‘ï¼Œç„¶åè®¿é—®metastoreï¼Œå¹¶æäº¤ä½œä¸šï¼Œæ˜¯è½»å®¢æˆ·ç«¯ã€‚ï¼ˆå› æ­¤åœ¨ä½¿ç”¨sentryæ¥ç®¡æ§æƒé™çš„æ—¶å€™ï¼Œé€šè¿‡hiveCliæ˜¯æ— æ³•å®Œç¾çš„åšåˆ°æƒé™ç®¡æ§çš„ï¼Œé€šè¿‡beeLineæ¥è¿›è¡Œæ“ä½œæ‰æ˜¯å¯ä»¥ï¼ŒåŸå› è§ä¸‹é¢hiveçš„æ‰©å±•æœºåˆ¶ï¼‰</li>
<li>Driverï¼šæ¥æ”¶æŸ¥è¯¢è¯·æ±‚ï¼Œå¹¶å¤„ç†ä¼šè¯</li>
<li>Complierï¼šè§£ææŸ¥è¯¢è¯­å¥ï¼Œåšè¯­ä¹‰åˆ†æï¼Œå€ŸåŠ©äºmetastoreæ¥ç”Ÿæˆæ‰§è¡Œè®¡åˆ’</li>
<li>Execution Engineï¼šç”¨æ¥æ‰§è¡Œç”Ÿæˆçš„æ‰§è¡Œè®¡åˆ’ï¼Œæ˜¯Hiveå’ŒHadoopçš„æ¡¥æ¢</li>
<li>metastoreï¼šæä¾›hiveå…ƒæ•°æ®ç›¸å…³çš„æœåŠ¡</li>
</ul>
<h2 id="HIVEæ‰©å±•æœºåˆ¶"><a href="#HIVEæ‰©å±•æœºåˆ¶" class="headerlink" title="HIVEæ‰©å±•æœºåˆ¶"></a>HIVEæ‰©å±•æœºåˆ¶</h2><p>ä¸‹é¢æ¥çœ‹ä¸€ä¸‹HIVEä¸­å­˜åœ¨çš„æ‰©å±•æœºåˆ¶ï¼Œsentryçš„æƒé™çš„æ§åˆ¶å°±æ˜¯åŸºäºè¿™ç§æ‰©å±•æœºåˆ¶å®Œæˆçš„ï¼š
<img src="//southrivers.github.io/2019/11/23/sentryå­¦ä¹ æ€»ç»“/hive%E6%89%A9%E5%B1%95%E6%9C%BA%E5%88%B6.png" alt>
åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œhiveé€šå¸¸ä¼šå¯¹åº”3ä¸ªä¸åŒçš„è¿›ç¨‹ï¼Œè¿™äº›è¿›ç¨‹åˆ†åˆ«æ˜¯Hive serverã€Metastoreã€RDBMSï¼Œå…¶ä¸­æä¾›æ‰©å±•æœºåˆ¶çš„æ˜¯ï¼š</p>
<ul>
<li>Metastoreçš„Listener</li>
<li>hive serverçš„Hook</li>
</ul>
<p>æµ‹è¯•éœ€è¦ï¼Œæˆ‘æœ¬åœ°æ­å»ºäº†ä¸€ä¸ªhiveçš„ç¯å¢ƒï¼Œä¸‹é¢æ˜¯é’ˆå¯¹Listenerå’ŒHookçš„æµ‹è¯•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.metastore.MetaStorePreEventListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.metastore.api.InvalidOperationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.metastore.api.MetaException;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.metastore.api.NoSuchObjectException;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.metastore.events.PreEventContext;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomListener1</span> <span class="keyword">extends</span> <span class="title">MetaStorePreEventListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomListener1</span><span class="params">(Configuration config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(config);</span><br><span class="line">        System.out.println(<span class="string">"åˆå§‹åŒ– CustomListener1"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(PreEventContext preEventContext)</span> <span class="keyword">throws</span> MetaException, NoSuchObjectException, InvalidOperationException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"MetaStorePreEventListener"</span> + preEventContext + preEventContext.getEventType());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.metastore.MetaStoreEventListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.metastore.api.MetaException;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.metastore.events.CreateTableEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.metastore.events.DropTableEvent;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomListener</span> <span class="keyword">extends</span> <span class="title">MetaStoreEventListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomListener</span><span class="params">(Configuration config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(config);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreateTable</span><span class="params">(CreateTableEvent tableEvent)</span> <span class="keyword">throws</span> MetaException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"wes create table : "</span> + tableEvent.getTable());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDropTable</span><span class="params">(DropTableEvent tableEvent)</span> <span class="keyword">throws</span> MetaException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"wes drop table : "</span> + tableEvent.getTable());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.hooks.ExecuteWithHookContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.hooks.HookContext;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HiveExampleHook</span> <span class="keyword">implements</span> <span class="title">ExecuteWithHookContext</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(HookContext hookContext)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"hello wes, this is hive hook !"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æ˜¯å°†è¿™äº›listenerã€hookæ³¨å†Œåˆ°hiveä¹‹åè¿è¡Œç›¸å…³çš„DDLã€DMLæ“ä½œçš„æ—¶å€™è§¦å‘çš„äº‹ä»¶ï¼Œå¦‚ä¸‹ï¼š
<img src="//southrivers.github.io/2019/11/23/sentryå­¦ä¹ æ€»ç»“/hive%E6%89%A9%E5%B1%95%E4%BB%A3%E7%A0%81%E6%BC%94%E7%A4%BA.png" alt>
ä¸Šé¢æµ‹è¯•çš„Listenerå’ŒHookä¹Ÿæ˜¯sentryä½¿ç”¨åˆ°çš„Listenerå’ŒHookï¼Œsentryä¸­ä½¿ç”¨Hooké‰´æƒï¼Œ
ä½¿ç”¨Listenerç›‘å¬æƒé™åŠç›¸å…³çš„å…ƒæ•°æ®çš„å˜æ›´ï¼Œ å¹¶é€šçŸ¥åˆ°æœåŠ¡ç«¯ï¼Œåœ¨sentryçš„listenerä¸­ä¼š
ä»ç”Ÿæˆçš„äº‹ä»¶ä¸­è·å–äº‹ä»¶çš„idï¼Œå¹¶å°†äº‹ä»¶çš„idè®°å½•åˆ°hiveçš„metastoreä¸­ï¼Œ ä¹‹åhiveçš„hivemetastoreclient
å®šæ—¶æ‹‰å–ç›¸å…³çš„äº‹ä»¶å¹¶æ›´æ–°åˆ°sentry serverç«¯çš„æ•°æ®åº“ä¸­ï¼Œ ä½†æ˜¯åœ¨å®é™…æµ‹è¯•çš„è¿‡ç¨‹ä¸­å´å‘ç°åº”
è¯¥å­˜åœ¨çš„äº‹ä»¶idçœŸå®æƒ…å†µå´æ˜¯nullï¼Œ çº¿ä¸Šæµ‹è¯•ç¯å¢ƒä¸­æœ‰ç›¸å…³çš„æŒ‡æ ‡ï¼Œæ€€ç–‘å’Œä½¿ç”¨çš„hiveç‰ˆæœ¬æœ‰å…³
ç³»æˆ–å¹¶éæ‰€æœ‰çš„eventéƒ½æœ‰eventidã€‚ æŸ¥çœ‹hiveçš„metastoreæ‰€ä½¿ç”¨åˆ°çš„æ•°æ®åº“å‘ç°æœ‰è¡¨ä¸“é—¨å¯¹
notificationè¿›è¡Œäº†è®°å½•ï¼Œä¸‹é¢å±•ç¤ºäº†eventidä¸ºç©ºçš„æƒ…å†µï¼š
<img src="//southrivers.github.io/2019/11/23/sentryå­¦ä¹ æ€»ç»“/id%E4%B8%BA%E7%A9%BA.png" alt>
å…³äºhiveçš„ç›¸å…³çš„çŸ¥è¯†å°±åˆ°è¿™é‡Œï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹sentryçš„æ•´ä½“æ¶æ„ã€‚</p>
<h1 id="sentry"><a href="#sentry" class="headerlink" title="sentry"></a>sentry</h1><h2 id="ERå…³ç³»å›¾"><a href="#ERå…³ç³»å›¾" class="headerlink" title="ERå…³ç³»å›¾"></a>ERå…³ç³»å›¾</h2><p>ä¸‹å›¾å±•ç¤ºäº†sentryçš„å®ä½“å…³ç³»å›¾ï¼ˆæœ‰äº›è¡¨çš„ä½œç”¨å°šä¸æ¸…æ¥šï¼‰
<img src="//southrivers.github.io/2019/11/23/sentryå­¦ä¹ æ€»ç»“/sentryER%E5%85%B3%E7%B3%BB%E5%9B%BE.png" alt>
ä¸Šé¢çš„å…³ç³»è¡¨å¯ä»¥çœ‹åˆ°çš„æ˜¯æƒé™çš„æ§åˆ¶æ˜¯é€šè¿‡RBACçš„æ–¹å¼ï¼Œä¸è¿‡è¿™é‡Œçš„è§’è‰²æ˜¯å’Œgroupç»‘å®šçš„ï¼Œå¹¶ä¸æ˜¯userï¼Œå¯ä»¥è®©ç”¨æˆ·åŠ å…¥ä¸åŒçš„ç»„æ¥å®Œæˆæƒé™çš„æ§åˆ¶ï¼Œ
ä¸è¿‡ç”¨æˆ·å’Œç»„çš„ç»‘å®šå…³ç³»å¹¶æ²¡æœ‰å¯¹åº”çš„è¡¨ï¼Œè€Œæ˜¯å¤ç”¨äº†hadoopä¸­userå’Œgroupçš„å…³ç³»ï¼Œè¿™ä¸€ç‚¹ä¸è®ºä»å½“å‰çš„è¡¨ä¸­è¿˜æ˜¯ä»£ç ä¸­éƒ½å¯ä»¥å¾—åˆ°å°è¯ã€‚</p>
<h2 id="sentryæ•´ä½“æ¶æ„"><a href="#sentryæ•´ä½“æ¶æ„" class="headerlink" title="sentryæ•´ä½“æ¶æ„"></a>sentryæ•´ä½“æ¶æ„</h2><p><img src="//southrivers.github.io/2019/11/23/sentryå­¦ä¹ æ€»ç»“/sentry%E6%9E%B6%E6%9E%84.png" alt>
å¦‚ä¸Šå›¾æ‰€ç¤ºä¸ºsentryæ•´ä½“æ¶æ„å›¾ï¼Œå…¶ä¸­sentry-bindingå°±æ˜¯åˆ©ç”¨äº†Hiveä¸Šé¢çš„æ‰©å±•æœºåˆ¶ï¼Œ
åˆ†åˆ«ä½¿ç”¨Listenerå’ŒHookå¯¹æ•°æ®çš„DDLã€DMLæ“ä½œè¿›è¡Œæƒé™çš„æ§åˆ¶ï¼Œsentryå®ç°çš„Listenerå’ŒHookçš„ä¸»è¦çš„ä½œç”¨ï¼š</p>
<ul>
<li>Listenerä¸»è¦æ˜¯é’ˆå¯¹DDLæ“ä½œå‘å¸ƒå¯¹åº”çš„äº‹ä»¶çš„idï¼Œè¿™æ ·sentryServerç«¯ä¼šä½¿ç”¨HMSFollowerä»hiveçš„metastoreå¤„è¿›è¡ŒåŒæ­¥ç›¸å…³çš„æ•°æ®ã€‚</li>
<li>Hookçš„è¯ï¼Œä¼šæˆªå–DMLä¸­çš„ä¿¡æ¯ï¼Œå¹¶è¿›è¡Œé‰´æƒæ“ä½œï¼Œä¹Ÿä¼šæˆªå–DDLä¸­çš„ä¿¡æ¯è¿›è¡Œæˆæƒæ“ä½œï¼Œè¿™ä¸ªå…·ä½“å¯ä»¥çœ‹ä¸‹é¢çš„ä»£ç </li>
</ul>
<h2 id="æƒé™çš„grantã€revokeä»¥åŠæƒé™çš„æ ¡éªŒ"><a href="#æƒé™çš„grantã€revokeä»¥åŠæƒé™çš„æ ¡éªŒ" class="headerlink" title="æƒé™çš„grantã€revokeä»¥åŠæƒé™çš„æ ¡éªŒ"></a>æƒé™çš„grantã€revokeä»¥åŠæƒé™çš„æ ¡éªŒ</h2><p>åœ¨hive-bindingæ¨¡å—çš„HiveAuthzBindingHookçš„postAnalyzeä¸­ä¼šå°†taskè½¬æ¢æˆSentryGrantRevokeTaskï¼ŒSentryGrantRevokeTaskä¸­é‡
å†™çš„executeæ–¹æ³•ä¸­é€šè¿‡RPCè¯·æ±‚æ‰§è¡Œäº†æƒé™çš„grantã€revokeæ“ä½œã€‚
HiveAuthzBindingHook ç»§æ‰¿äº†AbstractSemanticAnalyzerHookï¼Œé‡å†™çš„ä¸¤ä¸ªé‡è¦çš„æ–¹æ³•åˆ†åˆ«æ˜¯preAnalyzeã€postAnalyzeä¸¤ä¸ªæ–¹æ³•ï¼Œ
æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•æ‰€åšçš„æ“ä½œï¼š</p>
<h3 id="clientç«¯é‰´æƒæ“ä½œï¼ˆsentry-bindingæ¨¡å—ï¼‰"><a href="#clientç«¯é‰´æƒæ“ä½œï¼ˆsentry-bindingæ¨¡å—ï¼‰" class="headerlink" title="clientç«¯é‰´æƒæ“ä½œï¼ˆsentry-bindingæ¨¡å—ï¼‰"></a>clientç«¯é‰´æƒæ“ä½œï¼ˆsentry-bindingæ¨¡å—ï¼‰</h3><h4 id="preAnalyze"><a href="#preAnalyze" class="headerlink" title="preAnalyze"></a>preAnalyze</h4><p>ä¸‹é¢æ˜¯preAnalyzeæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°preAnalyzeæ‰€åšçš„æ“ä½œä»…ä»…æ˜¯æå–hiveSQLè¯­å¥ä¸­çš„åˆ†åŒºã€åº“ã€è¡¨ç­‰ä¿¡æ¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ASTNode <span class="title">preAnalyze</span><span class="params">(HiveSemanticAnalyzerHookContext context, ASTNode ast)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> SemanticException </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (ast.getToken().getType()) &#123;</span><br><span class="line">  <span class="comment">// Hive parser doesn't capture the database name in output entity, so we store it here for now</span></span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_CREATEDATABASE:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERDATABASE_PROPERTIES:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_DROPDATABASE:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_SWITCHDATABASE:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_DESCDATABASE:</span><br><span class="line">      <span class="comment">// é’ˆå¯¹åº“çš„æ“ä½œï¼Œåªéœ€è¦æå–å¯¹åº”çš„æ•°æ®åº“å³å¯</span></span><br><span class="line">      currDB = <span class="keyword">new</span> Database(BaseSemanticAnalyzer.unescapeIdentifier(ast.getChild(<span class="number">0</span>).getText()));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_CREATETABLE:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_CREATEVIEW:</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">       * Compiler doesn't create read/write entities for create table.</span></span><br><span class="line"><span class="comment">       * Hence we need extract dbname from db.tab format, if applicable</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      currDB = extractDatabase((ASTNode)ast.getChild(<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_DROPTABLE:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_DROPVIEW:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_SHOW_CREATETABLE:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERTABLE_SERIALIZER:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERVIEW_ADDPARTS:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERVIEW_DROPPARTS:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERVIEW_PROPERTIES:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERVIEW_RENAME:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERVIEW:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_DROPINDEX:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_LOCKTABLE:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_UNLOCKTABLE:</span><br><span class="line">      currTab = extractTable((ASTNode)ast.getFirstChildWithType(HiveParser.TOK_TABNAME));</span><br><span class="line">      currDB = extractDatabase((ASTNode) ast.getChild(<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_CREATEINDEX:</span><br><span class="line">      currTab = extractTable((ASTNode)ast.getFirstChildWithType(HiveParser.TOK_TABNAME));</span><br><span class="line">      currDB = extractDatabase((ASTNode) ast.getChild(<span class="number">0</span>));</span><br><span class="line">      indexURI = extractTableLocation(ast);<span class="comment">//As index location is captured using token HiveParser.TOK_TABLELOCATION</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERINDEX_REBUILD:</span><br><span class="line">      currTab = extractTable((ASTNode)ast.getChild(<span class="number">0</span>)); <span class="comment">//type is not TOK_TABNAME</span></span><br><span class="line">      currDB = extractDatabase((ASTNode) ast.getChild(<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_SHOW_TABLESTATUS:</span><br><span class="line">      currDB = extractDatabase((ASTNode)ast.getChild(<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">int</span> children = ast.getChildCount();</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; children; i++) &#123;</span><br><span class="line">        ASTNode child = (ASTNode) ast.getChild(i);</span><br><span class="line">        <span class="keyword">if</span> (child.getToken().getType() == HiveParser.Identifier) &#123;</span><br><span class="line">          currDB = <span class="keyword">new</span> Database(child.getText());</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//loosing the requested privileges for possible wildcard tables, since</span></span><br><span class="line">      <span class="comment">//further authorization will be done at the filter step and those unwanted will</span></span><br><span class="line">      <span class="comment">//eventually be filtered out from the output</span></span><br><span class="line">      currTab = Table.ALL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERTABLE_RENAME:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERTABLE_PROPERTIES:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERTABLE_DROPPARTS:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERTABLE_RENAMECOL:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERTABLE_ADDCOLS:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERTABLE_REPLACECOLS:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_SHOW_TBLPROPERTIES:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_SHOWINDEXES:</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_SHOWPARTITIONS:</span><br><span class="line">      <span class="comment">//token name TOK_TABNAME is not properly set in this case</span></span><br><span class="line">      currTab = extractTable((ASTNode)ast.getChild(<span class="number">0</span>));</span><br><span class="line">      currDB = extractDatabase((ASTNode)ast.getChild(<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_MSCK:</span><br><span class="line">      extractDbTableNameFromTOKTABLE((ASTNode) ast.getChild(<span class="number">1</span>));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_ALTERTABLE_ADDPARTS:</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">       * Compiler doesn't create read/write entities for create table.</span></span><br><span class="line"><span class="comment">       * Hence we need extract dbname from db.tab format, if applicable</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      currTab = extractTable((ASTNode)ast.getChild(<span class="number">0</span>));</span><br><span class="line">      currDB = extractDatabase((ASTNode)ast.getChild(<span class="number">0</span>));</span><br><span class="line">      <span class="comment">// è§£æsqlä¸­çš„åˆ†åŒº</span></span><br><span class="line">      partitionURI = extractPartition(ast);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_CREATEFUNCTION:</span><br><span class="line">      String udfClassName = BaseSemanticAnalyzer.unescapeSQLString(ast.getChild(<span class="number">1</span>).getText());</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        CodeSource udfSrc =</span><br><span class="line">            Class.forName(udfClassName, <span class="keyword">true</span>, Utilities.getSessionSpecifiedClassLoader())</span><br><span class="line">                .getProtectionDomain().getCodeSource();</span><br><span class="line">        <span class="keyword">if</span> (udfSrc == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> SemanticException(<span class="string">"Could not resolve the jar for UDF class "</span> + udfClassName);</span><br><span class="line">        &#125;</span><br><span class="line">        String udfJar = udfSrc.getLocation().getPath();</span><br><span class="line">        <span class="keyword">if</span> (udfJar == <span class="keyword">null</span> || udfJar.isEmpty()) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> SemanticException(<span class="string">"Could not find the jar for UDF class "</span> + udfClassName +</span><br><span class="line">              <span class="string">"to validate privileges"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        udfURIs.add(parseURI(udfSrc.getLocation().toString(), <span class="keyword">true</span>));</span><br><span class="line">      &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        List&lt;String&gt; functionJars = getFunctionJars(ast);</span><br><span class="line">        <span class="keyword">if</span> (functionJars.isEmpty()) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> SemanticException(<span class="string">"Error retrieving udf class:"</span> + e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// Add the jars from the command "Create function using jar" to the access list</span></span><br><span class="line">          <span class="comment">// Defer to hive to check if the class is in the jars</span></span><br><span class="line">          <span class="keyword">for</span>(String jar : functionJars) &#123;</span><br><span class="line">            udfURIs.add(parseURI(jar, <span class="keyword">false</span>));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// create/drop function is allowed with any database</span></span><br><span class="line">      currDB = Database.ALL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_DROPFUNCTION:</span><br><span class="line">      <span class="comment">// create/drop function is allowed with any database</span></span><br><span class="line">      currDB = Database.ALL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_LOAD:</span><br><span class="line">      String dbName = BaseSemanticAnalyzer.unescapeIdentifier(ast.getChild(<span class="number">1</span>).getChild(<span class="number">0</span>).getChild(<span class="number">0</span>).getText());</span><br><span class="line">      currDB = <span class="keyword">new</span> Database(dbName);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_DESCTABLE:</span><br><span class="line">      currDB = getCanonicalDb();</span><br><span class="line">      <span class="comment">// For DESCRIBE FORMATTED/EXTENDED ast will have an additional child node with value</span></span><br><span class="line">      <span class="comment">// "FORMATTED/EXTENDED".</span></span><br><span class="line">      isDescTableBasic = (ast.getChildCount() == <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HiveParser.TOK_TRUNCATETABLE:</span><br><span class="line">      <span class="comment">// SENTRY-826:</span></span><br><span class="line">      <span class="comment">// Truncate empty partitioned table should throw SemanticException only if the</span></span><br><span class="line">      <span class="comment">// user does not have permission.</span></span><br><span class="line">      <span class="comment">// In postAnalyze, currOutDB and currOutTbl will be added into outputHierarchy</span></span><br><span class="line">      <span class="comment">// which will be validated in the hiveAuthzBinding.authorize method.</span></span><br><span class="line">      Preconditions.checkArgument(ast.getChildCount() == <span class="number">1</span>);</span><br><span class="line">      <span class="comment">// childcount is 1 for table without partition, 2 for table with partitions</span></span><br><span class="line">      Preconditions.checkArgument(ast.getChild(<span class="number">0</span>).getChildCount() &gt;= <span class="number">1</span>);</span><br><span class="line">      ASTNode tableTok = (ASTNode) ast.getChild(<span class="number">0</span>).getChild(<span class="number">0</span>);</span><br><span class="line">      Preconditions.checkArgument(tableTok.getChildCount() &gt;= <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (tableTok.getChildCount() == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// If tableTok chilcount is 1, tableTok does not has database information, use current working DB</span></span><br><span class="line">        currOutDB = extractDatabase((ASTNode) ast.getChild(<span class="number">0</span>));</span><br><span class="line">        currOutTab = extractTable((ASTNode) tableTok.getChild(<span class="number">0</span>));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// If tableTok has fully-qualified name(childcount is 2),</span></span><br><span class="line">        <span class="comment">// get the db and table information from tableTok.</span></span><br><span class="line">        extractDbTableNameFromTOKTABLE(tableTok);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> HiveParser.TOK_ALTERTABLE:</span><br><span class="line">    currDB = getCanonicalDb();</span><br><span class="line">    <span class="keyword">for</span> (Node childNode : ast.getChildren()) &#123;</span><br><span class="line">      ASTNode childASTNode = (ASTNode) childNode;</span><br><span class="line">      <span class="keyword">if</span> (<span class="string">"TOK_ALTERTABLE_SERIALIZER"</span>.equals(childASTNode.getText())) &#123;</span><br><span class="line">        ASTNode serdeNode = (ASTNode) childASTNode.getChild(<span class="number">0</span>);</span><br><span class="line">        String serdeClassName = BaseSemanticAnalyzer.unescapeSQLString(serdeNode.getText());</span><br><span class="line">        setSerdeURI(serdeClassName);</span><br><span class="line">      &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"TOK_ALTERTABLE_RENAME"</span>.equals(childASTNode.getText())) &#123;</span><br><span class="line">        currDB = extractDatabase((ASTNode)ast.getChild(<span class="number">0</span>));</span><br><span class="line">        ASTNode newTableNode = (ASTNode)childASTNode.getChild(<span class="number">0</span>);</span><br><span class="line">        currOutDB = extractDatabase(newTableNode);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    currDB = getCanonicalDb();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ast;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="postAnalyze"><a href="#postAnalyze" class="headerlink" title="postAnalyze"></a>postAnalyze</h4><p>ä¸‹é¢æ˜¯postAnalyzeæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postAnalyze</span><span class="params">(HiveSemanticAnalyzerHookContext context,</span></span></span><br><span class="line"><span class="function"><span class="params">    List&lt;Task&lt;? extends Serializable&gt;&gt; rootTasks)</span> <span class="keyword">throws</span> SemanticException </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–stmtçš„æ“ä½œç±»å‹</span></span><br><span class="line">  HiveOperation stmtOperation = getCurrentHiveStmtOp();</span><br><span class="line">  <span class="comment">// inputPrivilegesï¼ˆæ“ä½œå¯¹åº”çš„è¾“å…¥è·¯å¾„ï¼‰, outputPrivilegesï¼ˆæ“ä½œå¯¹åº”çš„è¾“å‡ºè·¯å¾„ï¼‰, operationTypeï¼ˆDDLã€DMLã€QUERYç­‰æ“ä½œçš„ç±»å‹ï¼‰, operationScopeï¼ˆåº“ã€è¡¨ã€åˆ—ã€å‡½æ•°ç­‰ï¼‰</span></span><br><span class="line">  HiveAuthzPrivileges stmtAuthObject;</span><br><span class="line">  <span class="comment">// æ ¹æ®æ“ä½œçš„ç±»å‹è·å–å½“å‰è¿™ç§æ“ä½œå¿…é¡»è¦å…·å¤‡çš„æƒé™ï¼Œè¿™å¹¶ä¸éœ€è¦RPCè°ƒç”¨æ¥è·å–ç”¨æˆ·çš„æƒé™ï¼Œè€Œä»…ä»…æ˜¯è·å–è¿™ç§æ“ä½œéœ€è¦å…·å¤‡çš„æƒé™ï¼Œä¸»é¢˜æ˜¯æ“ä½œè€Œä¸æ˜¯ç”¨æˆ·</span></span><br><span class="line">  stmtAuthObject = HiveAuthzPrivilegesMap.getHiveAuthzPrivileges(stmtOperation);</span><br><span class="line">  <span class="comment">// must occur above the null check on stmtAuthObject</span></span><br><span class="line">  <span class="comment">// TODO æˆæƒã€å–æ¶ˆå¹¶ä¸æ˜¯åœ¨bindingæ¨¡å—ä¸­è®¤è¯çš„ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ since GRANT/REVOKE/etc are not authorized by binding layer at present</span></span><br><span class="line">  <span class="comment">// subjectåŒ…è£…ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">  Subject subject = getCurrentSubject(context);</span><br><span class="line">  <span class="comment">// ç›´æ¥ä»é…ç½®æ–‡ä»¶ä¸­è·å–ç”¨æˆ·æ‰€å±çš„ç»„çš„ä¿¡æ¯ï¼Œå› æ­¤å¯ä»¥çŒœæµ‹ç”¨æˆ·å’Œç»„çš„æ˜ å°„çš„å…³ç³»å¹¶ä¸æ˜¯åœ¨sentryçš„è¡¨ä¸­çš„ï¼Œè€Œæ˜¯å­˜åœ¨äºé…ç½®æ–‡ä»¶ä¸­ï¼ˆæŸ¥çœ‹è¡¨ä¿¡æ¯ç¡®å®å¦‚æ­¤ï¼‰</span></span><br><span class="line">  Set&lt;String&gt; subjectGroups = hiveAuthzBinding.getGroups(subject);</span><br><span class="line">  <span class="keyword">for</span> (Task&lt;? extends Serializable&gt; task : rootTasks) &#123;</span><br><span class="line">    <span class="keyword">if</span> (task <span class="keyword">instanceof</span> SentryGrantRevokeTask) &#123;</span><br><span class="line">      <span class="comment">// åº”è¯¥æ˜¯å°†åŸæ¥çš„æ— æƒé™çš„taskåŒ…è£…æˆæ–°çš„taskï¼Œè¯¥taskå†…éƒ¨æ‰§è¡Œæˆæƒã€å–æ¶ˆæˆæƒçš„æ“ä½œ</span></span><br><span class="line">      SentryGrantRevokeTask sentryTask = (SentryGrantRevokeTask)task;</span><br><span class="line">      sentryTask.setHiveAuthzBinding(hiveAuthzBinding);</span><br><span class="line">      sentryTask.setAuthzConf(authzConf);</span><br><span class="line">      sentryTask.setSubject(subject);</span><br><span class="line">      sentryTask.setSubjectGroups(subjectGroups);</span><br><span class="line">      sentryTask.setIpAddress(context.getIpAddress());</span><br><span class="line">      sentryTask.setOperation(stmtOperation);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (stmtAuthObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// We don't handle authorizing this statement</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Replace DDLTask using the SentryFilterDDLTask for protection,</span></span><br><span class="line"><span class="comment">     * such as "show column" only allow show some column that user can access to.</span></span><br><span class="line"><span class="comment">     * SENTRY-847</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rootTasks.size(); i++) &#123;</span><br><span class="line">      Task&lt;? extends Serializable&gt; task = rootTasks.get(i);</span><br><span class="line">      <span class="keyword">if</span> (task <span class="keyword">instanceof</span> DDLTask) &#123;</span><br><span class="line">        ShowColumnsDesc showCols = ((DDLTask) task).getWork().getShowColumnsDesc();</span><br><span class="line">        <span class="keyword">if</span> (showCols != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// é’ˆå¯¹DDLæ“ä½œï¼Œè¿™é‡Œæ˜¯åªå±•ç¤ºç”¨äºå…·å¤‡æƒé™çš„åˆ—</span></span><br><span class="line">          SentryFilterDDLTask filterTask =</span><br><span class="line">                  <span class="keyword">new</span> SentryFilterDDLTask(hiveAuthzBinding, subject, stmtOperation);</span><br><span class="line">          filterTask.copyDDLTask((DDLTask) task);</span><br><span class="line">          rootTasks.set(i, filterTask);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æœ€åè¿›è¡Œé‰´æƒï¼Œæ­¤å¤„ä¼šè¿œç¨‹è°ƒç”¨æ¥è·å–ç”¨æˆ·çš„æƒé™</span></span><br><span class="line">    authorizeWithHiveBindings(context, stmtAuthObject, stmtOperation);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (AuthorizationException e) &#123;</span><br><span class="line">    executeOnFailureHooks(context, stmtOperation, e);</span><br><span class="line">    String permsRequired = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span> (String perm : hiveAuthzBinding.getLastQueryPrivilegeErrors()) &#123;</span><br><span class="line">      permsRequired += perm + <span class="string">";"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    SessionState.get().getConf().set(HiveAuthzConf.HIVE_SENTRY_AUTH_ERRORS, permsRequired);</span><br><span class="line">    String msgForLog = HiveAuthzConf.HIVE_SENTRY_PRIVILEGE_ERROR_MESSAGE</span><br><span class="line">        + <span class="string">"\n Required privileges for this query: "</span></span><br><span class="line">        + permsRequired;</span><br><span class="line">    String msgForConsole = HiveAuthzConf.HIVE_SENTRY_PRIVILEGE_ERROR_MESSAGE + <span class="string">"\n "</span></span><br><span class="line">        + e.getMessage()+ <span class="string">"\n The required privileges: "</span> + permsRequired;</span><br><span class="line">    <span class="comment">// AuthorizationException is not a real exception, use the info level to record this.</span></span><br><span class="line">    LOG.info(msgForLog);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> SemanticException(msgForConsole, e);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    hiveAuthzBinding.close();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">"true"</span>.equalsIgnoreCase(context.getConf().</span><br><span class="line">      get(HiveAuthzConf.HIVE_SENTRY_MOCK_COMPILATION))) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> SemanticException(HiveAuthzConf.HIVE_SENTRY_MOCK_ERROR + <span class="string">" Mock query compilation aborted. Set "</span> +</span><br><span class="line">        HiveAuthzConf.HIVE_SENTRY_MOCK_COMPILATION + <span class="string">" to 'false' for normal query processing"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æœ€åè°ƒç”¨äº†authorizeWithHiveBindingsæ–¹æ³•ï¼Œè¿™é‡Œæ‰æ˜¯æƒé™æ ¡éªŒçš„åœ°æ–¹ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">authorizeWithHiveBindings</span><span class="params">(HiveSemanticAnalyzerHookContext context,</span></span></span><br><span class="line"><span class="function"><span class="params">    HiveAuthzPrivileges stmtAuthObject, HiveOperation stmtOperation)</span> <span class="keyword">throws</span>  AuthorizationException </span>&#123;</span><br><span class="line">  <span class="comment">// è·å–å½“å‰æ“ä½œè¾“å…¥ã€è¾“å‡ºç›¸å…³çš„ä¿¡æ¯</span></span><br><span class="line">  Set&lt;ReadEntity&gt; inputs = context.getInputs();</span><br><span class="line">  Set&lt;WriteEntity&gt; outputs = context.getOutputs();</span><br><span class="line">  List&lt;List&lt;DBModelAuthorizable&gt;&gt; inputHierarchy = <span class="keyword">new</span> ArrayList&lt;List&lt;DBModelAuthorizable&gt;&gt;();</span><br><span class="line">  List&lt;List&lt;DBModelAuthorizable&gt;&gt; outputHierarchy = <span class="keyword">new</span> ArrayList&lt;List&lt;DBModelAuthorizable&gt;&gt;();</span><br><span class="line">  <span class="keyword">if</span>(LOG.isDebugEnabled()) &#123;</span><br><span class="line">    LOG.debug(<span class="string">"stmtAuthObject.getOperationScope() = "</span> + stmtAuthObject.getOperationScope());</span><br><span class="line">    LOG.debug(<span class="string">"context.getInputs() = "</span> + context.getInputs());</span><br><span class="line">    LOG.debug(<span class="string">"context.getOutputs() = "</span> + context.getOutputs());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Workaround to allow DESCRIBE &lt;table&gt; to be executed with only column-level privileges, while</span></span><br><span class="line">  <span class="comment">// still authorizing DESCRIBE [EXTENDED|FORMATTED] as table-level.</span></span><br><span class="line">  <span class="comment">// This is done by treating DESCRIBE &lt;table&gt; the same as SHOW COLUMNS, which only requires column</span></span><br><span class="line">  <span class="comment">// level privs.</span></span><br><span class="line">  <span class="keyword">if</span> (isDescTableBasic) &#123;</span><br><span class="line">    stmtAuthObject = HiveAuthzPrivilegesMap.getHiveAuthzPrivileges(HiveOperation.SHOWCOLUMNS);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ ¹æ®æ“ä½œçš„å¯¹è±¡æå–å¯¹è±¡çš„ä¿¡æ¯ï¼Œåˆ†åˆ«å­˜æ”¾åˆ°è¾“å…¥ã€è¾“å‡ºçš„è®¤è¯æ¨¡å‹ä¸­</span></span><br><span class="line">  <span class="keyword">switch</span> (stmtAuthObject.getOperationScope()) &#123;</span><br><span class="line">  <span class="keyword">case</span> SERVER :</span><br><span class="line">    <span class="comment">// validate server level privileges if applicable. Eg create UDF,register jar etc ..</span></span><br><span class="line">    List&lt;DBModelAuthorizable&gt; serverHierarchy = <span class="keyword">new</span> ArrayList&lt;DBModelAuthorizable&gt;();</span><br><span class="line">    serverHierarchy.add(hiveAuthzBinding.getAuthServer());</span><br><span class="line">    inputHierarchy.add(serverHierarchy);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> DATABASE:</span><br><span class="line">    <span class="comment">// workaround for database scope statements (create/alter/drop db)</span></span><br><span class="line">    List&lt;DBModelAuthorizable&gt; dbHierarchy = <span class="keyword">new</span> ArrayList&lt;DBModelAuthorizable&gt;();</span><br><span class="line">    dbHierarchy.add(hiveAuthzBinding.getAuthServer());</span><br><span class="line">    dbHierarchy.add(currDB);</span><br><span class="line">    inputHierarchy.add(dbHierarchy);</span><br><span class="line">    <span class="keyword">if</span> (currOutDB != <span class="keyword">null</span>) &#123;</span><br><span class="line">      List&lt;DBModelAuthorizable&gt; outputDbHierarchy = <span class="keyword">new</span> ArrayList&lt;DBModelAuthorizable&gt;();</span><br><span class="line">      outputDbHierarchy.add(hiveAuthzBinding.getAuthServer());</span><br><span class="line">      outputDbHierarchy.add(currOutDB);</span><br><span class="line">      outputHierarchy.add(outputDbHierarchy);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      outputHierarchy.add(dbHierarchy);</span><br><span class="line">    &#125;</span><br><span class="line">    getInputHierarchyFromInputs(inputHierarchy, inputs);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> TABLE:</span><br><span class="line">    <span class="comment">// workaround for add partitions</span></span><br><span class="line">    <span class="keyword">if</span>(partitionURI != <span class="keyword">null</span>) &#123;</span><br><span class="line">      inputHierarchy.add(ImmutableList.of(hiveAuthzBinding.getAuthServer(), partitionURI));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(indexURI != <span class="keyword">null</span>) &#123;</span><br><span class="line">      outputHierarchy.add(ImmutableList.of(hiveAuthzBinding.getAuthServer(), indexURI));</span><br><span class="line">    &#125;</span><br><span class="line">    getInputHierarchyFromInputs(inputHierarchy, inputs);</span><br><span class="line">    <span class="keyword">for</span> (WriteEntity writeEntity: outputs) &#123;</span><br><span class="line">      <span class="keyword">if</span> (filterWriteEntity(writeEntity)) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      List&lt;DBModelAuthorizable&gt; entityHierarchy = <span class="keyword">new</span> ArrayList&lt;DBModelAuthorizable&gt;();</span><br><span class="line">      entityHierarchy.add(hiveAuthzBinding.getAuthServer());</span><br><span class="line">      entityHierarchy.addAll(getAuthzHierarchyFromEntity(writeEntity));</span><br><span class="line">      outputHierarchy.add(entityHierarchy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// workaround for metadata queries.</span></span><br><span class="line">    <span class="comment">// Capture the table name in pre-analyze and include that in the input entity list</span></span><br><span class="line">    <span class="keyword">if</span> (currTab != <span class="keyword">null</span>) &#123;</span><br><span class="line">      List&lt;DBModelAuthorizable&gt; externalAuthorizableHierarchy = <span class="keyword">new</span> ArrayList&lt;DBModelAuthorizable&gt;();</span><br><span class="line">      externalAuthorizableHierarchy.add(hiveAuthzBinding.getAuthServer());</span><br><span class="line">      externalAuthorizableHierarchy.add(currDB);</span><br><span class="line">      externalAuthorizableHierarchy.add(currTab);</span><br><span class="line">      inputHierarchy.add(externalAuthorizableHierarchy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// workaround for DDL statements</span></span><br><span class="line">    <span class="comment">// Capture the table name in pre-analyze and include that in the output entity list</span></span><br><span class="line">    <span class="keyword">if</span> (currOutTab != <span class="keyword">null</span>) &#123;</span><br><span class="line">      List&lt;DBModelAuthorizable&gt; externalAuthorizableHierarchy = <span class="keyword">new</span> ArrayList&lt;DBModelAuthorizable&gt;();</span><br><span class="line">      externalAuthorizableHierarchy.add(hiveAuthzBinding.getAuthServer());</span><br><span class="line">      externalAuthorizableHierarchy.add(currOutDB);</span><br><span class="line">      externalAuthorizableHierarchy.add(currOutTab);</span><br><span class="line">      outputHierarchy.add(externalAuthorizableHierarchy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> FUNCTION:</span><br><span class="line">    <span class="comment">/* The 'FUNCTION' privilege scope currently used for</span></span><br><span class="line"><span class="comment">     *  - CREATE TEMP FUNCTION</span></span><br><span class="line"><span class="comment">     *  - DROP TEMP FUNCTION.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!udfURIs.isEmpty()) &#123;</span><br><span class="line">      List&lt;DBModelAuthorizable&gt; udfUriHierarchy = <span class="keyword">new</span> ArrayList&lt;DBModelAuthorizable&gt;();</span><br><span class="line">      udfUriHierarchy.add(hiveAuthzBinding.getAuthServer());</span><br><span class="line">      udfUriHierarchy.addAll(udfURIs);</span><br><span class="line">      inputHierarchy.add(udfUriHierarchy);</span><br><span class="line">      <span class="keyword">for</span> (WriteEntity writeEntity : outputs) &#123;</span><br><span class="line">        List&lt;DBModelAuthorizable&gt; entityHierarchy = <span class="keyword">new</span> ArrayList&lt;DBModelAuthorizable&gt;();</span><br><span class="line">        entityHierarchy.add(hiveAuthzBinding.getAuthServer());</span><br><span class="line">        entityHierarchy.addAll(getAuthzHierarchyFromEntity(writeEntity));</span><br><span class="line">        outputHierarchy.add(entityHierarchy);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> CONNECT:</span><br><span class="line">    <span class="comment">/* The 'CONNECT' is an implicit privilege scope currently used for</span></span><br><span class="line"><span class="comment">     *  - USE &lt;db&gt;</span></span><br><span class="line"><span class="comment">     *  It's allowed when the user has any privilege on the current database. For application</span></span><br><span class="line"><span class="comment">     *  backward compatibility, we allow (optional) implicit connect permission on 'default' db.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;DBModelAuthorizable&gt; connectHierarchy = <span class="keyword">new</span> ArrayList&lt;DBModelAuthorizable&gt;();</span><br><span class="line">    connectHierarchy.add(hiveAuthzBinding.getAuthServer());</span><br><span class="line">    <span class="comment">// by default allow connect access to default db</span></span><br><span class="line">    Table currTbl = Table.ALL;</span><br><span class="line">    Column currCol = Column.ALL;</span><br><span class="line">    <span class="keyword">if</span> ((DEFAULT_DATABASE_NAME.equalsIgnoreCase(currDB.getName()) &amp;&amp;</span><br><span class="line">        <span class="string">"false"</span>.equalsIgnoreCase(authzConf.</span><br><span class="line">            get(HiveAuthzConf.AuthzConfVars.AUTHZ_RESTRICT_DEFAULT_DB.getVar(), <span class="string">"false"</span>)))) &#123;</span><br><span class="line">      currDB = Database.ALL;</span><br><span class="line">      currTbl = Table.SOME;</span><br><span class="line">    &#125;</span><br><span class="line">    connectHierarchy.add(currDB);</span><br><span class="line">    connectHierarchy.add(currTbl);</span><br><span class="line">    connectHierarchy.add(currCol);</span><br><span class="line">    inputHierarchy.add(connectHierarchy);</span><br><span class="line">    outputHierarchy.add(connectHierarchy);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> COLUMN:</span><br><span class="line">    <span class="keyword">for</span> (ReadEntity readEntity: inputs) &#123;</span><br><span class="line">      <span class="keyword">if</span> (readEntity.getAccessedColumns() != <span class="keyword">null</span> &amp;&amp; !readEntity.getAccessedColumns().isEmpty()) &#123;</span><br><span class="line">        addColumnHierarchy(inputHierarchy, readEntity);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        List&lt;DBModelAuthorizable&gt; entityHierarchy = <span class="keyword">new</span> ArrayList&lt;DBModelAuthorizable&gt;();</span><br><span class="line">        entityHierarchy.add(hiveAuthzBinding.getAuthServer());</span><br><span class="line">        entityHierarchy.addAll(getAuthzHierarchyFromEntity(readEntity));</span><br><span class="line">        entityHierarchy.add(Column.ALL);</span><br><span class="line">        inputHierarchy.add(entityHierarchy);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> AuthorizationException(<span class="string">"Unknown operation scope type "</span> +</span><br><span class="line">        stmtAuthObject.getOperationScope().toString());</span><br><span class="line">  &#125;</span><br><span class="line">  HiveAuthzBinding binding = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œæ¯”è¾ƒå…³é”®ï¼Œæ˜¯é€šè¿‡è¿œç¨‹è°ƒç”¨è·å–ç”¨æˆ·çš„æƒé™</span></span><br><span class="line">    binding = getHiveBindingWithPrivilegeCache(hiveAuthzBinding, context.getUserName());</span><br><span class="line">  &#125; <span class="keyword">catch</span> (SemanticException e) &#123;</span><br><span class="line">    <span class="comment">// Will use the original hiveAuthzBinding</span></span><br><span class="line">    binding = hiveAuthzBinding;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// validate permission</span></span><br><span class="line">  <span class="comment">// æœ€åä¸€æ­¥éªŒè¯æƒé™</span></span><br><span class="line">  binding.authorize(stmtOperation, stmtAuthObject, getCurrentSubject(context), inputHierarchy,</span><br><span class="line">      outputHierarchy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äºè·å–bindingçš„ä¼šé€šè¿‡è¿œç¨‹è°ƒç”¨è·å–æƒé™ï¼Œå› æ­¤æœ‰å¿…è¦çœ‹ä¸€ä¸‹è¿™ä¸€æ­¥çš„æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> HiveAuthzBinding <span class="title">getHiveBindingWithPrivilegeCache</span><span class="params">(HiveAuthzBinding hiveAuthzBinding,</span></span></span><br><span class="line"><span class="function"><span class="params">    String userName)</span> <span class="keyword">throws</span> SemanticException </span>&#123;</span><br><span class="line">  <span class="comment">// get the original HiveAuthzBinding, and get the user's privileges by AuthorizationProvider</span></span><br><span class="line">  AuthorizationProvider authProvider = hiveAuthzBinding.getCurrentAuthProvider();</span><br><span class="line">  <span class="comment">// è¿™ä¸€æ­¥å¾ˆå…³é”®ï¼ŒæŸ¥çœ‹å¯ä»¥çŸ¥é“è¿™ä¸€æ­¥ä¼šé€šè¿‡è¿œç¨‹è°ƒç”¨è·å–ç”¨æˆ·çš„æƒé™</span></span><br><span class="line">  Set&lt;String&gt; userPrivileges = authProvider.getPolicyEngine().getPrivileges(</span><br><span class="line">          authProvider.getGroupMapping().getGroups(userName), hiveAuthzBinding.getActiveRoleSet(),</span><br><span class="line">          hiveAuthzBinding.getAuthServer());</span><br><span class="line">  <span class="comment">// create PrivilegeCache using user's privileges</span></span><br><span class="line">  <span class="comment">// è¿™ä¸€æ­¥ä¸»è¦æ˜¯å°†ä¹‹å‰è·å–åˆ°çš„æƒé™æ•°æ®ç¼“å­˜ï¼Œä¾¿äºåœ¨åŒä¸€æ¬¡ä¼šè¯ä¸­ä½¿ç”¨</span></span><br><span class="line">  PrivilegeCache privilegeCache = <span class="keyword">new</span> SimplePrivilegeCache(userPrivileges);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// create new instance of HiveAuthzBinding whose backend provider should be SimpleCacheProviderBackend</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HiveAuthzBinding(HiveAuthzBinding.HiveHook.HiveServer2, hiveAuthzBinding.getHiveConf(),</span><br><span class="line">            hiveAuthzBinding.getAuthzConf(), privilegeCache);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    LOG.error(<span class="string">"Can not create HiveAuthzBinding with privilege cache."</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> SemanticException(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‡³äºæœ€åä¸€æ­¥æƒé™çš„æ ¡éªŒé€»è¾‘å°±ä¸å†èµ˜è¿°äº†ï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹ç›¸åº”çš„ä»£ç ã€‚ç”±ä¸Šé¢çš„ä»£ç åˆ†æå¯ä»¥çŸ¥é“ï¼Œ
Hookè¿™é‡Œå®ç°äº†æˆæƒï¼ˆSentryGrantRevokeTaskï¼‰ã€é‰´æƒï¼ˆ#getHiveBindingWithPrivilegeCacheï¼‰ï¼Œ
ä¹Ÿå³æ˜¯ç”¨æˆ·çš„æ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šè¢«è¿™ä¸€å±‚æ‹¦æˆªï¼Œå¹¶é’ˆå¯¹å¯¹è±¡çš„ç±»å‹æ‰§è¡Œç›¸å…³çš„æ“ä½œã€‚clientç«¯çš„é‰´æƒæ“ä½œåˆ°æ­¤å¯ä»¥å‘Šä¸€æ®µè½</p>
<h3 id="æœåŠ¡ç«¯é‰´æƒæ“ä½œ"><a href="#æœåŠ¡ç«¯é‰´æƒæ“ä½œ" class="headerlink" title="æœåŠ¡ç«¯é‰´æƒæ“ä½œ"></a>æœåŠ¡ç«¯é‰´æƒæ“ä½œ</h3><p>åœ¨clientç«¯é‰´æƒæ“ä½œçš„è¿‡ç¨‹ä¸­æˆ‘ä»¬çœ‹åˆ°äº†å®¢æˆ·ç«¯ä¼šé€šè¿‡è¿œç¨‹è°ƒç”¨æ‰§è¡Œæˆæƒæ“ä½œï¼Œä¹Ÿä¼šé€šè¿‡è¿œç¨‹è°ƒç”¨æ‰§è¡Œé‰´æƒæ“ä½œï¼Œè¿™ä¸ªè°ƒç”¨çš„è¿‡ç¨‹æ˜¯é€šè¿‡
RPCè°ƒç”¨æ¥å®ç°çš„ï¼Œ
æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹æœåŠ¡ç«¯çš„çš„æ“ä½œï¼ŒæœåŠ¡ç«¯çš„æ“ä½œä¸æ­¢åŒ…å«äº†é‰´æƒå’Œæˆæƒçš„æ“ä½œï¼Œè¿˜åŒ…å«äº†å…¶ä»–çš„æ“ä½œï¼Œå› æ­¤æˆ‘ä»¬æœ‰å¿…è¦å…ˆæ¦‚è¦çš„ä»‹ç»
ä¸€ä¸‹æœåŠ¡ç«¯çš„æ“ä½œï¼Œç„¶å
è¯¦ç»†çš„ä»‹ç»ä¸€ä¸‹é‰´æƒå’Œæˆæƒçš„æ“ä½œã€‚é€šè¿‡ä¸Šé¢çš„æ•´ä½“æ¶æ„å›¾æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒæœåŠ¡ç«¯çš„å…¥å£åœ¨sentryServiceè¿™ä¸ªç±»ä¸­ï¼Œä¸»è¦çš„ç»„æˆéƒ¨
åˆ†å¦‚ä¸Šå›¾æ‰€ç¤ºå…¶ä¸­åŒ…å«çš„æ¨¡å—å’Œæ¯ä¸€ä¸ªæ¨¡å—çš„é‡è¦ä½œç”¨å¦‚ä¸‹ï¼š</p>
<ul>
<li>thrift serverï¼šé’ˆå¯¹hookã€listenerå‘é€è¿‡æ¥çš„äº‹ä»¶åšç›¸åº”çš„å¤„ç†æ“ä½œï¼Œå¤„ç†çš„é€»è¾‘åœ¨sentryPolicyStoreProcessor</li>
<li>sentryWebServerï¼šsentryServiceå†…ç½®çš„ä¸€ä¸ªåŸºäºjettyçš„webserverï¼Œæœ‰å¯¹åº”çš„ç•Œé¢ï¼šhttp://${sentry.server.url}:29000ï¼ŒæŸ¥çœ‹äº†ä¸€ä¸‹ä¸»è¦æ˜¯ä¸€äº›é…ç½®ä¿¡æ¯å’Œä¸€äº›ç›‘æ§æ•°æ®</li>
<li>sentryStoreï¼šï¼ˆæ˜¯ä¸€ä¸ªå•ä¾‹ï¼‰sentryStoreåœ¨SentryServiceçš„æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–çš„ï¼Œåˆå§‹åŒ–çš„æ—¶å€™æœ‰é’ˆå¯¹æ˜¯å¦å¼€å¯HDFSåŒæ­¥åšæ£€æµ‹ã€‚</li>
<li>leadMonitorï¼šsentryå¼€å¯é«˜å¯ç”¨ä¹‹åï¼Œç”¨æ¥ç›‘å¬leaderå˜æ›´çš„ç»„ä»¶</li>
<li>HMSFollowerï¼šå°è£…äº†hivemetastoreclientï¼Œç”¨äºä»hivemetastoreä¸­åŒæ­¥hiveç›¸å…³çš„å…ƒæ•°æ®</li>
</ul>
<p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹sentryServiceçš„å…¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  SentryKerberosContext kerberosContext = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    status = Status.STARTED;</span><br><span class="line">    <span class="keyword">if</span> (kerberos) &#123;</span><br><span class="line">      kerberosContext = <span class="keyword">new</span> SentryKerberosContext(principal, keytab, <span class="keyword">true</span>);</span><br><span class="line">      Subject.doAs(kerberosContext.getSubject(), <span class="keyword">new</span> PrivilegedExceptionAction&lt;Void&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">          runServer();</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      runServer();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception t) &#123;</span><br><span class="line">    LOGGER.error(<span class="string">"Error starting server"</span>, t);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Error starting server"</span>, t);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (kerberosContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">      kerberosContext.shutDown();</span><br><span class="line">    &#125;</span><br><span class="line">    status = Status.NOT_STARTED;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°callæ–¹æ³•å†…ä»…ä»…æ˜¯é’ˆå¯¹æ˜¯å¦å¼€å¯kerberosè¿›è¡Œåˆ¤æ–­ï¼Œæœ€ç»ˆå…¥å£éƒ½ä¼šè°ƒç”¨runServeræ–¹æ³•ï¼Œè·Ÿè¿›runServeræ–¹æ³•æ¥çœ‹ä¸€ä¸‹ï¼š</p>
<p>1ã€é¦–å…ˆä¼šå¯åŠ¨ä¸€äº›æ¸…ç†å·¥ä½œ</p>
<p>2ã€æ¥ä¸‹æ¥ä¼šå¯åŠ¨HMSFollowerï¼Œé¦–å…ˆä¼šè·å–metastoreçš„thrifturiï¼Œç„¶åä¼šä»¥500msçš„å‘¨æœŸå®šæ—¶è°ƒåº¦ï¼Œåœ¨hmsfolloweræ„é€ å‡½æ•°ä¸­ï¼Œä¼šåˆ†åˆ«å®ä¾‹åŒ–
NotificationProcessorï¼šç”¨äºå¤„ç†notificationï¼Œä¸»è¦æ˜¯é’ˆå¯¹DDLæ“ä½œé€šè¿‡sentrystoreæŒä¹…åŒ–å˜æ›´ï¼ˆè¿™é‡Œä¼šåˆ¤æ–­æ˜¯å¦å¼€å¯HDFSåŒæ­¥ï¼‰ã€‚
SentryHMSClientï¼šä¼šé¦–å…ˆè·å–sentryStoreçš„notificationçš„idï¼Œè·å–æ‰€æœ‰çš„åº“è¡¨ä¿¡æ¯ï¼ˆæ²¡æœ‰æŒä¹…åŒ–ï¼‰ï¼Œæ¥ä¸‹æ¥å†æ¬¡è·å–notificationçš„idï¼Œ
å¦‚æœä¸¤æ¬¡è·å–åˆ°çš„idç›¸åŒï¼Œè¯´æ˜åœ¨åŒæ­¥åº“è¡¨ä¿¡æ¯çš„è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰æ–°çš„DDLæ“ä½œï¼Œè¿™å°±è¡¨ç¤ºå·²ç»å®ŒæˆåŒæ­¥æ“ä½œã€‚å¦‚æœä¸¤æ¬¡notificationçš„idä¸åŒï¼Œ
è¯´æ˜åŒæ­¥åº“è¡¨ä¿¡æ¯çš„æ—¶å€™æœ‰DDLæ“ä½œï¼Œè¿™ä¸ªæ—¶å€™åªéœ€è¦ç»§ç»­åŒæ­¥å³å¯ã€‚
HiveNotificationFetcherï¼šä¼šä½¿ç”¨sentryHMSClientè·å–notification</p>
<p>3ã€æ¥ä¸‹æ¥ä¼šæ„å»ºthrift serverï¼Œthrift serveråŒ…å«äº†processoré€»è¾‘ï¼ˆç”¨äºå¤„ç†RPCè¯·æ±‚ï¼Œè¿™é‡Œä¸»è¦æ˜¯æƒé™çš„ä¸€äº›æ ¡éªŒï¼‰
å’Œsentrystoreï¼ˆæŒä¹…åŒ–ï¼‰çš„é€»è¾‘ï¼Œä¹‹åå¯åŠ¨sentryServiceçš„æœåŠ¡ç«¯æ¥å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚</p>
<p>4ã€ç„¶åå¯åŠ¨sentryWebServerï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸€äº›é…ç½®ä¿¡æ¯çš„æŸ¥çœ‹å’Œå†…ç½®çš„ä¸€äº›ç›‘æ§æ•°æ®
<img src="//southrivers.github.io/2019/11/23/sentryå­¦ä¹ æ€»ç»“/webserver.png" alt>
ä¸Šé¢çš„é‰´æƒã€æˆæƒçš„ä¸»è¦çš„ä¸šåŠ¡é€»è¾‘æ˜¯åœ¨thriftserverçš„processorä¸­ï¼Œå¯¹åº”çš„å®ç°ç±»ä¸ºï¼šSentryPolicyStoreProcessorï¼Œ
æˆ‘ä»¬å¯ä»¥å…·ä½“æŸ¥çœ‹ä¸€ä¸‹ç›¸å…³çš„é€»è¾‘ï¼Œä¸‹é¢æ˜¯è¯¥ç±»ä¸­åŒ…å«çš„æ–¹æ³•ï¼š
<img src="//southrivers.github.io/2019/11/23/sentryå­¦ä¹ æ€»ç»“/thriftserver.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TCreateSentryRoleResponse <span class="title">create_sentry_role</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  TCreateSentryRoleRequest request)</span> <span class="keyword">throws</span> TException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Timer.Context timerContext = sentryMetrics.createRoleTimer.time();</span><br><span class="line">  TCreateSentryRoleResponse response = <span class="keyword">new</span> TCreateSentryRoleResponse();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    validateClientVersion(request.getProtocol_version());</span><br><span class="line">    <span class="comment">// æ ¡éªŒå½“å‰ç”¨æˆ·çš„æƒé™ï¼Œåˆ›å»ºè§’è‰²æ˜¯ç‰¹æ®Šçš„æƒé™ï¼Œéœ€è¦ç”¨æˆ·æ‰€åœ¨çš„groupå’Œadminæ‰€åœ¨çš„groupå­˜åœ¨äº¤é›†ï¼Œå¦‚æœä¸æ»¡è¶³è¦æ±‚ä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    authorize(request.getRequestorUserName(),</span><br><span class="line">        getRequestorGroups(request.getRequestorUserName()));</span><br><span class="line">    <span class="comment">// å°†å¯¹åº”çš„è§’è‰²æŒä¹…åŒ–åˆ°sentryçš„æ•°æ®åº“ä¸­</span></span><br><span class="line">    sentryStore.createSentryRole(request.getRoleName());</span><br><span class="line">    response.setStatus(Status.OK());</span><br><span class="line">    <span class="comment">// è´£ä»»é“¾æ¨¡å¼çš„ä¸šåŠ¡ï¼ŒåŠŸèƒ½æœªçŸ¥</span></span><br><span class="line">    notificationHandlerInvoker.create_sentry_role(request, response);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (SentryAlreadyExistsException e) &#123;</span><br><span class="line">    String msg = <span class="string">"Role: "</span> + request + <span class="string">" already exists."</span>;</span><br><span class="line">    LOGGER.error(msg, e);</span><br><span class="line">    response.setStatus(Status.AlreadyExists(e.getMessage(), e));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (SentryAccessDeniedException e) &#123;</span><br><span class="line">    LOGGER.error(e.getMessage(), e);</span><br><span class="line">    response.setStatus(Status.AccessDenied(e.getMessage(), e));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (SentryThriftAPIMismatchException e) &#123;</span><br><span class="line">    LOGGER.error(e.getMessage(), e);</span><br><span class="line">    response.setStatus(Status.THRIFT_VERSION_MISMATCH(e.getMessage(), e));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    String msg = <span class="string">"Unknown error for request: "</span> + request + <span class="string">", message: "</span> + e.getMessage();</span><br><span class="line">    LOGGER.error(msg, e);</span><br><span class="line">    response.setStatus(Status.RuntimeError(msg, e));</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    timerContext.stop();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    AUDIT_LOGGER.info(JsonLogEntityFactory.getInstance()</span><br><span class="line">        .createJsonLogEntity(request, response, conf).toJsonFormatLog());</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="comment">// if any exception, log the exception.</span></span><br><span class="line">    String msg = <span class="string">"Error creating audit log for create role: "</span> + e.getMessage();</span><br><span class="line">    LOGGER.error(msg, e);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢ä»£ç æ ¸å¿ƒä»£ç åªæœ‰ä¸‰è¡Œï¼Œæˆ‘ä»¬å·²ç»å¯¹å…¶è¿›è¡Œæ ‡æ³¨ï¼Œå…¶ä»–çš„ä¸šåŠ¡å¤„ç†æµç¨‹ç±»ä¼¼ï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹ç›¸å…³çš„ä»£ç ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<h2 id="è¡¨å˜æ›´äº‹ä»¶åŒæ­¥"><a href="#è¡¨å˜æ›´äº‹ä»¶åŒæ­¥" class="headerlink" title="è¡¨å˜æ›´äº‹ä»¶åŒæ­¥"></a>è¡¨å˜æ›´äº‹ä»¶åŒæ­¥</h2><p>clientç«¯è§¦å‘notificationçš„åœ°æ–¹æ˜¯SentrySyncHMSNotificationsPostEventListenerè¿™ä¸ªç±»ï¼Œå¦‚ä¸‹ï¼š
ä¸Šé¢è¿™äº›æ–¹æ³•åœ¨ç›‘å¬åˆ°ç‰¹å®šçš„äº‹ä»¶çš„æ—¶å€™ä¼šè§¦å‘notificationï¼ŒæŸ¥çœ‹hiveçš„metastoreå¯¹åº”çš„æ•°æ®åº“å‘ç°æœ‰é’ˆ
å¯¹notificationçš„è®°å½•ï¼Œå¦‚ä¸‹ä¸ºç›‘å¬åˆ°ç‰¹å®šäº‹ä»¶ä¹‹åçš„clientçš„è§¦å‘æœºåˆ¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">syncNotificationEvents</span><span class="params">(ListenerEvent event, String eventName)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Do not sync notifications if the event has failed.</span></span><br><span class="line">  <span class="keyword">if</span> (failedEvent(event, eventName)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Map&lt;String, String&gt; eventParameters = event.getParameters();</span><br><span class="line">  <span class="keyword">if</span> (!eventParameters.containsKey(MetaStoreEventListenerConstants.DB_NOTIFICATION_EVENT_ID_KEY_NAME)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* If the HMS is running in an active transaction, then we do not want to sync with Sentry</span></span><br><span class="line"><span class="comment">   * because the desired eventId is not available for Sentry yet, and Sentry may block the HMS</span></span><br><span class="line"><span class="comment">   * forever or until a read time-out happens. */</span></span><br><span class="line">  <span class="keyword">if</span> (isMetastoreTransactionActive(eventParameters)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">long</span> eventId =</span><br><span class="line">      Long.parseLong(eventParameters.get(MetaStoreEventListenerConstants.DB_NOTIFICATION_EVENT_ID_KEY_NAME));</span><br><span class="line">  <span class="comment">// This check is only for performance reasons to avoid calling the sync thrift call if the Sentry server</span></span><br><span class="line">  <span class="comment">// already processed the requested eventId.</span></span><br><span class="line">  <span class="keyword">if</span> (eventId &lt;= latestProcessedId.get()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ä¸Šé¢æ˜¯å¯¹eventçš„åˆæ³•æ€§åšçš„æ ¡éªŒï¼Œå¯ä»¥ä¸ç”¨å…³å¿ƒ</span></span><br><span class="line">  <span class="keyword">try</span>(SentryPolicyServiceClient sentryClient = <span class="keyword">this</span>.getSentryServiceClient()) &#123;</span><br><span class="line">    LOGGER.debug(<span class="string">"Starting Sentry/HMS notifications sync for &#123;&#125; (id: &#123;&#125;)"</span>, eventName, eventId);</span><br><span class="line">        <span class="comment">// å°†æœ€æ–°çš„notificationIdé€šçŸ¥åˆ°æœåŠ¡ç«¯</span></span><br><span class="line">    <span class="keyword">long</span> sentryLatestProcessedId = sentryClient.syncNotifications(eventId);</span><br><span class="line">    LOGGER.debug(<span class="string">"Finishedd Sentry/HMS notifications sync for &#123;&#125; (id: &#123;&#125;)"</span>, eventName, eventId);</span><br><span class="line">    LOGGER.debug(<span class="string">"Latest processed event ID returned by the Sentry server: &#123;&#125;"</span>, sentryLatestProcessedId);</span><br><span class="line">        <span class="comment">// æ›´æ–°æœ¬åœ°çš„latestProcessedIdï¼Œé»˜è®¤çš„æƒ…å†µä¸‹ï¼Œåœ¨clientå¯åŠ¨çš„æ—¶å€™latestProcessedIdæ˜¯0</span></span><br><span class="line">    updateProcessedId(sentryLatestProcessedId);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="comment">// This error is only logged. There is no need to throw an error to Hive because HMS sync is called</span></span><br><span class="line">    <span class="comment">// after the notification is already generated by Hive (as post-event).</span></span><br><span class="line">    LOGGER.error(<span class="string">"Failed to sync requested HMS notifications up to the event ID: "</span> + eventId, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚ä¸‹ï¼Œè¿˜æ˜¯åœ¨SentryPolicyStoreProcessorè¿™ä¸ªç±»ä¸­ï¼ŒæœåŠ¡ç«¯ä¼šå¯¹å®¢æˆ·ç«¯å‘è¿‡æ¥çš„æ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TSentrySyncIDResponse <span class="title">sentry_sync_notifications</span><span class="params">(TSentrySyncIDRequest request)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> TException </span>&#123;</span><br><span class="line">  TSentrySyncIDResponse response = <span class="keyword">new</span> TSentrySyncIDResponse();</span><br><span class="line">  <span class="keyword">try</span> (Timer.Context timerContext = hmsWaitTimer.time()) &#123;</span><br><span class="line">    <span class="comment">// Wait until Sentry Server processes specified HMS Notification ID.</span></span><br><span class="line">        <span class="comment">// é˜»å¡æœåŠ¡ç«¯ï¼Œç›´è‡³å¤„ç†å®Œè¯¥notification</span></span><br><span class="line">    response.setId(sentryStore.getCounterWait().waitFor(request.getId()));</span><br><span class="line">    response.setStatus(Status.OK());</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    String msg = String.format(<span class="string">"wait request for id %d is interrupted"</span>,</span><br><span class="line">            request.getId());</span><br><span class="line">    LOGGER.error(msg, e);</span><br><span class="line">    response.setId(<span class="number">0</span>);</span><br><span class="line">    response.setStatus(Status.RuntimeError(msg, e));</span><br><span class="line">    Thread.currentThread().interrupt();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">    String msg = String.format(<span class="string">"timed out wait request for id %d"</span>, request.getId());</span><br><span class="line">    LOGGER.warn(msg, e);</span><br><span class="line">    response.setId(<span class="number">0</span>);</span><br><span class="line">    response.setStatus(Status.RuntimeError(msg, e));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¸å¿ƒä»£ç åªæœ‰ä¸€è¡Œï¼Œæˆ‘ä»¬çœ‹åˆ°åœ¨sentryStoreä¸­åŒ…å«äº†ä¸€ä¸ªcounterWaiterï¼Œè¯¥å˜é‡ä¼šç”¨åœ¨thriftserverå’ŒhmsfolloweråŒæ­¥notificationï¼Œ
å­˜æ”¾åœ¨sentryStoreå¹¶ä¸åˆé€‚ï¼Œåªä¸è¿‡sentryStoreæ˜¯thriftserverå’Œhmsfollowerå”¯ä¸€çš„çº½å¸¦ï¼Œåé¢å¯èƒ½ä¼šè°ƒæ•´ã€‚
åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œé€šè¿‡counterWaiterå®ç°äº†notificationçš„å‘å¸ƒæœºåˆ¶ï¼ŒçœŸæ­£çš„å¤„ç†é€»è¾‘åœ¨hmsfollowerä¸­ï¼Œ
å› æ­¤æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹hmsfolloweræ˜¯æ€ä¹ˆå¤„ç†è¿™äº›äº‹ä»¶çš„ã€‚Hmsfollowerçš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HMSFollower</span><span class="params">(Configuration conf, SentryStore store, LeaderStatusMonitor leaderMonitor,</span></span></span><br><span class="line"><span class="function"><span class="params">            HiveConnectionFactory hiveConnectionFactory, String authServerName)</span> </span>&#123;</span><br><span class="line">  LOGGER.info(<span class="string">"HMSFollower is being initialized"</span>);</span><br><span class="line">  readyToServe = <span class="keyword">false</span>;</span><br><span class="line">  authzConf = conf;</span><br><span class="line">  <span class="keyword">this</span>.leaderMonitor = leaderMonitor;</span><br><span class="line">  sentryStore = store;</span><br><span class="line">  <span class="keyword">if</span> (authServerName == <span class="keyword">null</span>) &#123;</span><br><span class="line">    authServerName = conf.get(AUTHZ_SERVER_NAME.getVar(),</span><br><span class="line">      conf.get(AUTHZ_SERVER_NAME_DEPRECATED.getVar(), AUTHZ_SERVER_NAME_DEPRECATED.getDefault()));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ç”¨äºå¤„ç†ä»hive metastoreæ¥æ”¶åˆ°çš„æ•°æ®</span></span><br><span class="line">  notificationProcessor = <span class="keyword">new</span> NotificationProcessor(sentryStore, authServerName, authzConf);</span><br><span class="line">  <span class="comment">// åŒ…è£…äº†hiveMetaStoreçš„å®¢æˆ·ç«¯ï¼Œç”¨äºä»hiveå…ƒæ•°æ®ä»“åº“è·å–ç›¸åº”çš„æ•°æ®</span></span><br><span class="line">  client = <span class="keyword">new</span> SentryHMSClient(authzConf, hiveConnectionFactory);</span><br><span class="line">  hdfsSyncEnabled = SentryServiceUtil.isHDFSSyncEnabledNoCache(authzConf); <span class="comment">// no cache to test different settings for hdfs sync</span></span><br><span class="line">  <span class="comment">// ä½¿ç”¨å°è£…çš„clientè·å–ç›¸åº”çš„æ•°æ®</span></span><br><span class="line">  notificationFetcher = <span class="keyword">new</span> HiveNotificationFetcher(sentryStore, hiveConnectionFactory);</span><br><span class="line">  <span class="comment">// subscribe to full update notification</span></span><br><span class="line">  <span class="keyword">if</span> (conf.getBoolean(ServerConfig.SENTRY_SERVICE_FULL_UPDATE_PUBSUB, <span class="keyword">false</span>)) &#123;</span><br><span class="line">    LOGGER.info(FULL_UPDATE_TRIGGER + <span class="string">"subscribing to topic "</span> + PubSub.Topic.HDFS_SYNC_HMS.getName());</span><br><span class="line">    PubSub.getInstance().subscribe(PubSub.Topic.HDFS_SYNC_HMS, <span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¯”è¾ƒé‡è¦çš„åœ°æ–¹éƒ½å·²ç»ç”¨ä¸­æ–‡æ³¨é‡Šï¼Œä»åå­—å¯ä»¥å¤§è‡´çœ‹å‡ºæ¥notificationFetcheræ˜¯ç”¨æ¥ä»hiveçš„metastoreä¸­æ‹‰å–notificationçš„ï¼ŒnotificationProcessoræ˜¯ç”¨æ¥å¤„ç†è·å–åˆ°çš„notificationçš„ã€‚ 
ç”±äºhmsæ˜¯å®šæ—¶è°ƒåº¦çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡å®šæ—¶è°ƒåº¦çš„æ–¹æ³•ä½œä¸ºå…¥å£æ¥åˆ†æhmsfollowerï¼Œå¯¹åº”çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ç”¨äºå‘å¸ƒHMSFollowerçš„çŠ¶æ€</span></span><br><span class="line">  SentryStateBank.enableState(HMSFollowerState.COMPONENT,HMSFollowerState.STARTED);</span><br><span class="line">  <span class="keyword">long</span> lastProcessedNotificationId;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// Initializing lastProcessedNotificationId based on the latest persisted notification ID.</span></span><br><span class="line">      lastProcessedNotificationId = sentryStore.getLastProcessedNotificationID();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      LOGGER.error(<span class="string">"Failed to get the last processed notification id from sentry store, "</span></span><br><span class="line">          + <span class="string">"Skipping the processing"</span>, e);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Wake any clients connected to this service waiting for HMS already processed notifications.</span></span><br><span class="line">        <span class="comment">// å”¤é†’æ‰€æœ‰åœ¨lastProcessedNotificationIdä¸Šç­‰å¾…çš„clientï¼Œè¿™é‡Œçš„clientå¯¹åº”çš„æ˜¯ä»hivemetastoreåŒæ­¥æ•°æ®çš„clientï¼ˆçŒœæµ‹ï¼‰</span></span><br><span class="line">    wakeUpWaitingClientsForSync(lastProcessedNotificationId);</span><br><span class="line">    <span class="comment">// Only the leader should listen to HMS updates</span></span><br><span class="line">    <span class="keyword">if</span> (!isLeader()) &#123;</span><br><span class="line">      <span class="comment">// Close any outstanding connections to HMS</span></span><br><span class="line">      close();</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¤„ç†æ–°åˆ°è¾¾çš„notifications</span></span><br><span class="line">    syncupWithHms(lastProcessedNotificationId);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// é‡ç½®çŠ¶æ€</span></span><br><span class="line">    SentryStateBank.disableState(HMSFollowerState.COMPONENT,HMSFollowerState.STARTED);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¸å¿ƒçš„ä»£ç åœ¨syncupWithHmsä¸­ï¼Œæœ€ç»ˆæ–¹æ³•ä¼šè°ƒåº¦åˆ°notificationProcessor.processNotificationEvent(event)ï¼Œ
è¿›å…¥è¯¥æ–¹æ³•å‘ç°ä¼šé’ˆå¯¹ç‰¹å®šçš„äº‹ä»¶æ‰§è¡Œæƒé™çš„å˜æ›´æ“ä½œï¼Œå…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (Context ignored = timer.time()) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (eventType) &#123;</span><br><span class="line">      <span class="keyword">case</span> CREATE_DATABASE:</span><br><span class="line">        <span class="keyword">return</span> processCreateDatabase(event);</span><br><span class="line">      <span class="keyword">case</span> DROP_DATABASE:</span><br><span class="line">        <span class="keyword">return</span> processDropDatabase(event);</span><br><span class="line">      <span class="keyword">case</span> CREATE_TABLE:</span><br><span class="line">        <span class="keyword">return</span> processCreateTable(event);</span><br><span class="line">      <span class="keyword">case</span> DROP_TABLE:</span><br><span class="line">        <span class="keyword">return</span> processDropTable(event);</span><br><span class="line">      <span class="keyword">case</span> ALTER_TABLE:</span><br><span class="line">        <span class="keyword">return</span> processAlterTable(event);</span><br><span class="line">      <span class="keyword">case</span> ADD_PARTITION:</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;       <span class="comment">// return processAddPartition(event);</span></span><br><span class="line">      <span class="keyword">case</span> DROP_PARTITION:</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;       <span class="comment">// return processDropPartition(event);</span></span><br><span class="line">      <span class="keyword">case</span> ALTER_PARTITION:</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;       <span class="comment">//return processAlterPartition(event);</span></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        LOGGER.error(<span class="string">"Notification with ID:&#123;&#125; has invalid event type: &#123;&#125;"</span>, event.getEventId(),</span><br><span class="line">            event.getEventType());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿›å…¥åˆ°å¯¹åº”çš„æ–¹æ³•æŸ¥çœ‹ï¼Œå‘ç°æ ¹æ®å…·ä½“çš„äº‹ä»¶åŒæ­¥çš„å˜æ›´æƒé™ï¼Œå¦‚ï¼šåˆ é™¤æ•°æ®åº“ä¼šæŠŠæ•°æ®åº“ç›¸å…³çš„æƒé™çš„æ•°æ®éƒ½åˆ é™¤ã€‚åœ¨å®ŒæˆåŒæ­¥æ“ä½œä¹‹åä¼šè®°å½•åˆ°æ•°æ®åº“ä¸­æœ¬æ¬¡metastoreçš„å˜æ›´ã€‚</p>
<h2 id="Hdfs-namenodeé‰´æƒ"><a href="#Hdfs-namenodeé‰´æƒ" class="headerlink" title="Hdfs namenodeé‰´æƒ"></a>Hdfs namenodeé‰´æƒ</h2><h3 id="å…ƒæ•°æ®åŒæ­¥"><a href="#å…ƒæ•°æ®åŒæ­¥" class="headerlink" title="å…ƒæ•°æ®åŒæ­¥"></a>å…ƒæ•°æ®åŒæ­¥</h3><p>hdfs namenodeä¼šå®šæœŸä»sentry serverä¸­åŒæ­¥æƒé™ä»¥åŠhiveçš„å…ƒæ•°æ®ï¼Œç¨‹åºçš„å…¥å£åœ¨SentryAuthorizationProviderï¼Œæœ€ç»ˆä¼šé€šè¿‡SentryAuthorizationInfoå®šæ—¶æ›´æ–°authzPathså’ŒauthzPermissionsï¼Œæ ¸å¿ƒä»£ç åœ¨ç±»SentryAuthorizationInfoä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">//Looks like getting same updates multiple times</span></span><br><span class="line">  SentryAuthzUpdate updates = updater.getUpdates();</span><br><span class="line">  <span class="comment">// Updates can be null if Sentry Service is un-reachable</span></span><br><span class="line">  <span class="keyword">if</span> (updates != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (updates.isEmpty()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// no updates is a norm, it's still success</span></span><br><span class="line">    &#125;</span><br><span class="line">    UpdateableAuthzPaths newAuthzPaths = processUpdates(</span><br><span class="line">        updates.getPathUpdates(), authzPaths);</span><br><span class="line">    UpdateableAuthzPermissions newAuthzPerms = processUpdates(</span><br><span class="line">        updates.getPermUpdates(), authzPermissions);</span><br><span class="line">    <span class="comment">// processUpdates() should return different newAuthzPaths and newAuthzPerms object references</span></span><br><span class="line">    <span class="comment">// if FULL updates were fetched from the Sentry server, otherwise, the same authzPaths and authzPermissions</span></span><br><span class="line">    <span class="comment">// objects will be returned.</span></span><br><span class="line">    <span class="keyword">if</span> (newAuthzPaths != authzPaths || newAuthzPerms != authzPermissions) &#123;</span><br><span class="line">      lock.writeLock().lock();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">          LOG.debug(updates.dumpContent());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (newAuthzPaths != authzPaths) &#123;</span><br><span class="line">          LOG.info(String.format(<span class="string">"FULL Updated paths seq Num [old=%d], [new=%d]"</span>,</span><br><span class="line">            authzPaths.getLastUpdatedSeqNum(), newAuthzPaths.getLastUpdatedSeqNum()));</span><br><span class="line">          authzPaths = newAuthzPaths;</span><br><span class="line">          <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">            LOG.trace(authzPaths.dumpContent());</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (newAuthzPerms != authzPermissions) &#123;</span><br><span class="line">          LOG.info(String.format(<span class="string">"FULL Updated perms seq Num [old=%d], [new=%d]"</span>,</span><br><span class="line">            authzPermissions.getLastUpdatedSeqNum(), newAuthzPerms.getLastUpdatedSeqNum()));</span><br><span class="line">          authzPermissions = newAuthzPerms;</span><br><span class="line">          <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">            LOG.trace(authzPermissions.dumpContent());</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.writeLock().unlock();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">        lock.writeLock().lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          LOG.debug(updates.dumpContent());</span><br><span class="line">          <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">            LOG.trace(newAuthzPaths.dumpContent());</span><br><span class="line">            LOG.trace(newAuthzPerms.dumpContent());</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          lock.writeLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæ›´æ–°æƒé™æˆ–è€…hiveå…ƒæ•°æ®çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨ä¸€ä¸ªreadwritelockæ¥å®ç°çº¿ç¨‹ä¹‹é—´çš„åŒæ­¥ï¼Œè¿™ä¸€å—åº”è¯¥æ˜¯è€ƒè™‘è®©ä¸¤ä¸ªå˜é‡çš„åŒæ­¥æ›´æ–°ã€‚è¿™ä¸€ä¸ªé”åœ¨æ›´æ–°æ•°æ®çš„æ—¶å€™ä¼šè®©å…¶ä»–çš„è¯»æ“ä½œé˜»å¡ï¼Œå› æ­¤å¯èƒ½ä¼šäº§ç”Ÿæ€§èƒ½ç“¶é¢ˆã€‚</p>
<h3 id="é‰´æƒæ“ä½œ"><a href="#é‰´æƒæ“ä½œ" class="headerlink" title="é‰´æƒæ“ä½œ"></a>é‰´æƒæ“ä½œ</h3><p>hdfsé‰´æƒæ“ä½œåœ¨ç±»SentryAuthorizationProviderä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkPermission</span><span class="params">(String user, Set&lt;String&gt; groups,</span></span></span><br><span class="line"><span class="function"><span class="params">     INodeAuthorizationInfo[] inodes, <span class="keyword">int</span> snapshotId,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">boolean</span> doCheckOwner, FsAction ancestorAccess, FsAction parentAccess,</span></span></span><br><span class="line"><span class="function"><span class="params">     FsAction access, FsAction subAccess, <span class="keyword">boolean</span> ignoreEmptyDir)</span></span></span><br><span class="line"><span class="function">     <span class="keyword">throws</span> AccessControlException, UnresolvedLinkException </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">     <span class="comment">// Note: Arrays.asList() returns "[null]" string for null argument</span></span><br><span class="line">     LOG.debug(<span class="string">"### checkPermission(): "</span> +</span><br><span class="line">               <span class="string">"User &#123;&#125;, Groups &#123;&#125;, Nodes &#123;&#125;, snapshotId &#123;&#125;, "</span> +</span><br><span class="line">               <span class="string">"doCheckOwner &#123;&#125;, ancestorAccess &#123;&#125;, parentAccess &#123;&#125;, "</span> +</span><br><span class="line">               <span class="string">"access &#123;&#125;, subAccess &#123;&#125;, ignoreEmptyDir &#123;&#125;"</span>,</span><br><span class="line">       user, groups, Arrays.asList(inodes), snapshotId,</span><br><span class="line">       doCheckOwner, ancestorAccess, parentAccess,</span><br><span class="line">       access, subAccess, ignoreEmptyDir);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">   <span class="comment">//ç»•è¿‡åŸç”ŸNNé‰´æƒè¿‡ç¨‹å¯¹xæƒé™çš„åˆ¤æ–­ï¼ŒDefaultAuthorizationProvider.checkPermissionä»è·ŸèŠ‚ç‚¹é€çº§åˆ¤æ–­xæƒé™</span></span><br><span class="line">   <span class="comment">//ç›´æ¥returnè¡¨ç¤ºé‰´æƒæˆåŠŸï¼Œé‰´æƒå¤±è´¥æ—¶ä¼šæŠ›å¼‚å¸¸</span></span><br><span class="line">   <span class="comment">//http://km.vivo.xyz/pages/viewpage.action?pageId=85251073</span></span><br><span class="line">   <span class="keyword">if</span> (!doCheckOwner &amp;&amp; ancestorAccess == <span class="keyword">null</span> &amp;&amp; parentAccess == <span class="keyword">null</span> &amp;&amp; </span><br><span class="line">          access == <span class="keyword">null</span> &amp;&amp; subAccess == <span class="keyword">null</span> &amp;&amp; !ignoreEmptyDir) &#123;</span><br><span class="line">  <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">    LOG.debug(<span class="string">"### checkPermission() return: "</span> +</span><br><span class="line">              <span class="string">"User &#123;&#125;, Groups &#123;&#125;, Nodes &#123;&#125;, snapshotId &#123;&#125;, "</span> +</span><br><span class="line">              <span class="string">"doCheckOwner &#123;&#125;, ancestorAccess &#123;&#125;, parentAccess &#123;&#125;, "</span> +</span><br><span class="line">              <span class="string">"access &#123;&#125;, subAccess &#123;&#125;, ignoreEmptyDir &#123;&#125;"</span>,</span><br><span class="line">      user, groups, Arrays.asList(inodes), snapshotId,</span><br><span class="line">      doCheckOwner, ancestorAccess, parentAccess,</span><br><span class="line">      access, subAccess, ignoreEmptyDir);</span><br><span class="line">  &#125;</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//filter to check</span></span><br><span class="line">   <span class="comment">//è¿‡æ»¤hiveæ‰§è¡Œmrå’Œsparkä»»åŠ¡äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶çš„é‰´æƒ</span></span><br><span class="line">   <span class="keyword">if</span> (isFilter(inodes, <span class="string">"checkPermission()"</span>)) &#123;</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="comment">//åªè¿›è¡Œä¸€æ¬¡é‰´æƒ</span></span><br><span class="line">  inodes = truncate(inodes, doCheckOwner, ancestorAccess, parentAccess);</span><br><span class="line">     <span class="keyword">if</span> (inodes.length == <span class="number">1</span> &amp;&amp; access == <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span> (subAccess != <span class="keyword">null</span>) &#123;</span><br><span class="line">         access = subAccess;</span><br><span class="line">         subAccess = <span class="keyword">null</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ancestorAccess != <span class="keyword">null</span>) &#123;</span><br><span class="line">         access = ancestorAccess;</span><br><span class="line">         ancestorAccess = <span class="keyword">null</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parentAccess != <span class="keyword">null</span>) &#123;</span><br><span class="line">         access = parentAccess;</span><br><span class="line">         parentAccess = <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">  LOG.warn(<span class="string">"### truncate Exception. "</span> +</span><br><span class="line">         <span class="string">"User &#123;"</span> + user + <span class="string">"&#125;, Groups &#123;"</span> + groups + <span class="string">"&#125;, Nodes &#123;"</span> + Arrays.asList(inodes) + <span class="string">"&#125;, snapshotId &#123;"</span> + snapshotId + <span class="string">"&#125;, "</span> + </span><br><span class="line">     <span class="string">"doCheckOwner &#123;"</span> + doCheckOwner + <span class="string">"&#125;, ancestorAccess &#123;"</span> + ancestorAccess + <span class="string">"&#125;, parentAccess &#123;"</span> + parentAccess + <span class="string">"&#125;, "</span> + </span><br><span class="line">         <span class="string">"access &#123;"</span> + access + <span class="string">"&#125;, subAccess &#123;"</span> + subAccess + <span class="string">"&#125;, ignoreEmptyDir &#123;"</span> + ignoreEmptyDir + <span class="string">"&#125;, FullPath &#123;"</span> + </span><br><span class="line">     (inodes[<span class="number">0</span>] == <span class="keyword">null</span> ? <span class="string">"null"</span> : inodes[<span class="number">0</span>].getFullPathName()) + <span class="string">"&#125; taken &#123;"</span> + (System.currentTimeMillis() - start) + <span class="string">"&#125;."</span>, e);</span><br><span class="line">&#125;</span><br><span class="line">   <span class="keyword">long</span> truncateTime = System.currentTimeMillis() - start;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     defaultAuthzProvider.checkPermission(user, groups, inodes, snapshotId,</span><br><span class="line">       doCheckOwner, ancestorAccess, parentAccess, access, subAccess,</span><br><span class="line">       ignoreEmptyDir);</span><br><span class="line">     <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">       LOG.debug(<span class="string">"### checkPermission(): "</span> +</span><br><span class="line">                 <span class="string">"User &#123;&#125;, Groups &#123;&#125;, Nodes &#123;&#125;, snapshotId &#123;&#125;, "</span> + </span><br><span class="line">                <span class="string">"doCheckOwner &#123;&#125;, ancestorAccess &#123;&#125;, parentAccess &#123;&#125;, "</span> + </span><br><span class="line">                 <span class="string">"access &#123;&#125;, subAccess &#123;&#125;, ignoreEmptyDir &#123;&#125;, FullPath &#123;&#125; taken &#123;&#125;, truncateTime &#123;&#125;"</span>,</span><br><span class="line">         user, groups, Arrays.asList(inodes), snapshotId,</span><br><span class="line">         doCheckOwner, ancestorAccess, parentAccess,</span><br><span class="line">         access, subAccess, ignoreEmptyDir, inodes[<span class="number">0</span>] == <span class="keyword">null</span> ? <span class="string">"null"</span> : inodes[<span class="number">0</span>].getFullPathName(), </span><br><span class="line">                (System.currentTimeMillis() - start), truncateTime);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (AccessControlException e) &#123;</span><br><span class="line">     LOG.debug(<span class="string">"### AccessControlException"</span>, e);</span><br><span class="line">     <span class="keyword">throw</span> e;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (UnresolvedLinkException e) &#123;</span><br><span class="line">     LOG.debug(<span class="string">"### UnresolvedLinkException"</span>, e);</span><br><span class="line">     <span class="keyword">throw</span> e;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">     LOG.error(<span class="string">"### Unexpected Exception"</span>, e);</span><br><span class="line">     <span class="keyword">throw</span> e;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæœ€ç»ˆæ˜¯ç”±äºdefaultAuthzProvideræ¥è¿›è¡Œæƒé™çš„æ ¡éªŒçš„ï¼Œå› æ­¤SentryAuthorizationProvideræ›´å¤šçš„åƒæ˜¯ä¸€ä¸ªé—¨é¢ã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>sentryæƒé™çš„ç®¡æ§ç”¨åˆ°äº†hiveçš„hookã€listeneræœºåˆ¶ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªåˆ‡é¢æ“ä½œï¼Œè¿™é‡Œæ¯”è¾ƒé‡è¦çš„ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºåº”å½“æ˜¯DDLã€DMLæ“ä½œæ•°æ®çš„æå–ï¼Œ
è¿™æ ·å¦‚æœåœ¨å®šåˆ¶åŒ–æƒé™æ§åˆ¶çš„æ—¶å€™æ‰å¯ä»¥åšåˆ°è¾ƒå¿«çš„å“åº”</p>

            
                

            
        </div>
        <div class="post-tool">
            <a class="btn-thumbs-up" href="javascript:void(0);" data-cid="52" title="95">
                <i class="fa fa-thumbs-up" aria-hidden="true"></i> æ‰“èµ
            </a>
        </div>
        
        <div class="post-tags">tagsï¼š
            
        </div>
        
    </article>
    
        <p style="text-align: center">æœ¬æ–‡ä»£è¡¨ä¸ªäººè§‚ç‚¹ï¼Œå†…å®¹ä»…ä¾›å‚è€ƒ</p>
    
    
    

</div>
<script src="/js/busuanzi.pure.mini.js"></script>


        </div><!-- end #main-->
    </div><!-- end #body -->
    <footer class="footer">
    <div class="footer-inner" style="text-align: center">

    </div>
</footer>
<script src="/js/SimpleCore.js"></script>

</div>
<!-- search pop -->
<div class="popup search-popup local-search-popup">
    <div class="local-search-header clearfix">
        <span class="search-icon">
            <i class="fa fa-search"></i>
        </span>
        <span class="popup-btn-close">
            <i class="fa fa-times-circle"></i>
        </span>
        <div class="local-search-input-wrapper">
            <input id="local-search-input" spellcheck="false" type="text" autocomplete="off" placeholder="è¯·è¾“å…¥æŸ¥è¯¢å…³é”®è¯">
        </div>
    </div>
    <div id="local-search-result"></div>
</div>
<div class="fixed-btn">
    <a class="btn-gotop" href="javascript:"> <i class="fa fa-angle-up"></i></a>
</div>
<script>
    $(function () {
        var jsi_config = {
            buildingTime: '01/20/2018',
            current: $('.post-tags').length > 0 ? 'post' : 'archive',
            snsQRCode: '/images/sns-qrcode.png',
            donateImg: '/images/donate-qr.png',
            localSearch: { dbPath: '' },
            readMode: 'day'
        };
        
            jsi_config.localSearch = {
                dbPath: '/search.xml',
                trigger: 'auto',
                topN: '1',
                unescape: 'false'
            }
        
        SimpleCore.init(jsi_config);
        
    });
</script>
</body>
</html>
